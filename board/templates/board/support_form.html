<!-- django_ma/board/templates/board/support_form.html -->
{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}ì—…ë¬´ìš”ì²­ì„œ{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 800px;">
    <h3 class="mb-4 text-center fw-bold" style="color:#003f7d;">ì—…ë¬´ìš”ì²­ì„œ</h3>

    <div class="card shadow p-4 border-0 rounded-4">
      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- âœ… ìš”ì²­ ëŒ€ìƒ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold mb-0" style="color:#003f7d;">ìš”ì²­ëŒ€ìƒ</h6>
          <button type="button" id="resetUserBtn" class="btn btn-outline-secondary btn-sm">
            ì´ˆê¸°í™”
          </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3 align-items-center">
          <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
          <div class="col-md-1 text-center">
            <button type="button" class="btn btn-sm btn-primary search-btn"
                    style="margin-top:-4px;"
                    data-row="{{ i }}" data-bs-toggle="modal" data-bs-target="#searchUserModal">
              ê²€ìƒ‰
            </button>
          </div>

          <!-- íšŒìƒ‰ ë¹„í™œì„± í•„ë“œ -->
          <div class="col equal-field mb-2">
            <label class="form-label">ì„±ëª…</label>
            <input type="text" name="target_name_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">ì‚¬ë²ˆ</label>
            <input type="text" name="target_code_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">ì…ì‚¬ì¼</label>
            <input type="date" name="target_join_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">í‡´ì‚¬ì¼</label>
            <input type="text" name="target_leave_{{ i }}" class="form-control readonly-field">
          </div>
        </div>
        {% endfor %}

        <hr>

        <!-- âœ… ê³„ì•½ì‚¬í•­ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0" style="color:#005BAC;">ê³„ì•½ì‚¬í•­</h6>
        <button type="button" id="resetContractBtn" class="btn btn-outline-secondary btn-sm">
            ì´ˆê¸°í™”
        </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3">
        <div class="col-md-3 mb-2">
            <label class="form-label">ë³´í—˜ì‚¬</label>
            <input type="text" name="insurer_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ì¦ê¶Œë²ˆí˜¸</label>
            <input type="text" name="policy_no_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ê³„ì•½ì(í”¼ë³´í—˜ì)</label>
            <input type="text" name="contractor_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ë³´í—˜ë£Œ</label>
            <input type="text" name="premium_{{ i }}" class="form-control">
        </div>
        </div>
        {% endfor %}

        <hr>

        <!-- âœ… ìš”ì²­ ë‚´ìš© -->
        <h6 class="fw-bold mb-3" style="color:#005BAC;">ìš”ì²­ ë‚´ìš©</h6>
        <div class="mb-3">
          <label class="form-label">ì œëª©</label>
          <input type="text" name="title" class="form-control" placeholder="ì œëª© ì…ë ¥">
        </div>
        <div class="mb-4">
          <label class="form-label">ë‚´ìš©</label>
          <textarea name="content" class="form-control" rows="5" placeholder="ìš”ì²­ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
        </div>

        <!-- âœ… ë²„íŠ¼ -->
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4">ë’¤ë¡œê°€ê¸°</a>
          <button type="button" id="generatePdfBtn" class="btn btn-primary px-5 fw-bold">ì œì‘í•˜ê¸°</button>
        </div>

        <!-- âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loadingOverlay" 
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(255,255,255,0.85); z-index:9999; text-align:center;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
            <div class="spinner-border text-primary" role="status" style="width:4rem; height:4rem;">
            <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3 fw-bold" style="color:#005BAC;">ì œì‘ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</h5>
        </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… ëŒ€ìƒì ê²€ìƒ‰ ëª¨ë‹¬ -->
<div class="modal fade" id="searchUserModal" tabindex="-1" aria-labelledby="searchUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h6 class="modal-title fw-bold" id="searchUserModalLabel">ëŒ€ìƒì ê²€ìƒ‰</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="searchUserForm" class="d-flex gap-2">
          <input type="text" class="form-control" id="searchKeyword" name="q" placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì„±ëª… ì…ë ¥">
          <button type="submit" class="btn btn-primary flex-shrink-0">ê²€ìƒ‰</button>
        </form>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .readonly-field {
    background-color: #f0f0f0 !important; /* íšŒìƒ‰ ë°°ê²½ */
    pointer-events: none; /* í´ë¦­ ì°¨ë‹¨ */
    color: #6c757d; /* ê¸€ì”¨ íšŒìƒ‰ */
  }

  .readonly-field:focus {
    outline: none;
    box-shadow: none;
  }

  .equal-field {
    flex: 1;
    min-width: 0;
  }
</style>

<style>
  .readonly-field {
    background-color: #f0f0f0 !important;
    pointer-events: none; /* í´ë¦­ë§Œ ë§‰ìŒ, ê°’ì€ ì „ì†¡ë¨ */
    color: #333;
    font-weight: 500;
  }
</style>


<!-- âœ… [1] ëŒ€ìƒì ê²€ìƒ‰ ë° ìë™ì…ë ¥ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - ëŒ€ìƒì ê²€ìƒ‰ ëª¨ë‹¬ì—ì„œ ê²€ìƒ‰ì–´ ì…ë ¥ í›„ ê²°ê³¼ í‘œì‹œ
 * - ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ í–‰ì˜ input í•„ë“œ ìë™ ì±„ì›€
 * - currentRow ë³€ìˆ˜ë¡œ í˜„ì¬ ì„ íƒëœ í–‰(row) ì¶”ì 
 */
let currentRow = null;

// ğŸ§© ê° í–‰ë³„ "ê²€ìƒ‰" ë²„íŠ¼ í´ë¦­ ì‹œ, ëª‡ ë²ˆì§¸ í–‰(row)ì¸ì§€ ì €ì¥
document.querySelectorAll('.search-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // ì˜ˆ: 1, 2, 3 ... ë²ˆì§¸ í–‰
    currentRow = this.dataset.row;
  });
});

// ğŸ§© ëª¨ë‹¬ ë‚´ ê²€ìƒ‰í¼ (ëŒ€ìƒì ê²€ìƒ‰ ì‹¤í–‰)
document.getElementById('searchUserForm').addEventListener('submit', function(e) {
  e.preventDefault(); // ê¸°ë³¸ form ì œì¶œ ë§‰ê¸°

  const query = document.getElementById('searchKeyword').value.trim(); // ì…ë ¥ëœ ê²€ìƒ‰ì–´
  const resultsBox = document.getElementById('searchResults'); // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­
  resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ì¤‘...</p>';

  // âœ… Django /board/search-user/ API í˜¸ì¶œ
  fetch(`/board/search-user/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      resultsBox.innerHTML = ''; // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”

      // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ
      if (data.results.length === 0) {
        resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // ê²€ìƒ‰ ê²°ê³¼ë¥¼ list-group í˜•íƒœë¡œ í‘œì‹œ
      const list = document.createElement('div');
      list.classList.add('list-group');

      data.results.forEach(user => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action';

        // ê²€ìƒ‰ ê²°ê³¼ UI ìƒì„±
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <span><strong>${user.name}</strong> (${user.id}) (${user.regist})</span>
                <small class="text-muted">${user.branch}</small>
            </div>
            <small class="text-muted">ì…ì‚¬ì¼: ${user.enter || '-'} / í‡´ì‚¬ì¼: ${user.quit || '-'}</small>
        `;

        // âœ… ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ â†’ í•´ë‹¹ í–‰ input ì±„ìš°ê¸°
        item.addEventListener('click', () => {
          if (!currentRow) return;

          // í˜„ì¬ ì„ íƒëœ í–‰(row)ì— í•´ë‹¹í•˜ëŠ” input ìš”ì†Œë“¤ ì°¾ê¸°
          const nameInput = document.querySelector(`input[name="target_name_${currentRow}"]`);
          const codeInput = document.querySelector(`input[name="target_code_${currentRow}"]`);
          const joinInput = document.querySelector(`input[name="target_join_${currentRow}"]`);
          const leaveInput = document.querySelector(`input[name="target_leave_${currentRow}"]`);

          // DBì—ì„œ ë°›ì•„ì˜¨ ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
          nameInput.value = user.name || '';
          codeInput.value = user.code || user.id || '';
          joinInput.value = user.join_date || user.enter || '';

          // âœ… í‡´ì‚¬ì¼ì´ ì—†ìœ¼ë©´ "ì¬ì§ì¤‘" ìë™ í‘œì‹œ
          const leaveDate = user.leave_date || user.quit;
          leaveInput.value = leaveDate ? leaveDate : 'ì¬ì§ì¤‘';

          // âœ… ëª¨ë‹¬ ë‹«ê¸°
          bootstrap.Modal.getInstance(document.getElementById('searchUserModal')).hide();
        });

        list.appendChild(item);
      });

      resultsBox.appendChild(list);
    })
    .catch(() => {
      resultsBox.innerHTML = '<p class="text-danger small text-center">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    });
});
</script>

<!-- âœ… [2] ëª¨ë‹¬ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - ëª¨ë‹¬ì„ ë‹«ì•˜ë‹¤ ë‹¤ì‹œ ì—´ ë•Œ, ì´ì „ ê²€ìƒ‰ ê²°ê³¼ ë° ê²€ìƒ‰ì–´ë¥¼ ì´ˆê¸°í™”
 */
const searchModal = document.getElementById('searchUserModal');
searchModal.addEventListener('show.bs.modal', function () {
  // ê²€ìƒ‰ì°½ê³¼ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').innerHTML = '';
});
</script>

<!-- âœ… [3] ì´ˆê¸°í™” ë²„íŠ¼ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - "ìš”ì²­ëŒ€ìƒ ì´ˆê¸°í™”" ë²„íŠ¼ í´ë¦­ ì‹œ â†’ ëŒ€ìƒì ì…ë ¥ í•„ë“œ ì „ì²´ ë¦¬ì…‹
 * - "ê³„ì•½ì‚¬í•­ ì´ˆê¸°í™”" ë²„íŠ¼ í´ë¦­ ì‹œ â†’ ë³´í—˜ì‚¬/ì¦ê¶Œë²ˆí˜¸/ê³„ì•½ì/ë³´í—˜ë£Œ í•„ë“œ ì „ì²´ ë¦¬ì…‹
 */

// âœ… ëŒ€ìƒì ì •ë³´ ì´ˆê¸°í™”
document.getElementById('resetUserBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="target_name_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_code_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_join_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_leave_"]').forEach(el => el.value = '');
});

// âœ… ê³„ì•½ì‚¬í•­ ì´ˆê¸°í™”
document.getElementById('resetContractBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="insurer_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="policy_no_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="contractor_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="premium_"]').forEach(el => el.value = '');
});
</script>

<!-- âœ… [4] PDF ìƒì„± ë° ì „ì†¡ ìŠ¤í¬ë¦½íŠ¸ (ì™„ì „ ìˆ˜ì • ë²„ì „) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const overlay = document.getElementById("loadingOverlay");
  const generateBtn = document.getElementById("generatePdfBtn");

  generateBtn.addEventListener("click", async function () {
    overlay.style.display = "block";

    try {
      // âœ… ê¸°ë³¸ FormData ìƒì„±
      const formData = new FormData();

      // âœ… ëª¨ë“  input, textarea, select ê°•ì œ ìˆ˜ì§‘ (readonly í¬í•¨)
      document.querySelectorAll("input, textarea, select").forEach((el) => {
        if (el.name) {
          const val = el.value || "";
          formData.append(el.name, val);
          console.log(`ğŸ“© ì¶”ê°€ë¨ â†’ ${el.name}: ${val}`);
        }
      });

      // âœ… ìš”ì²­ì ì •ë³´ ì¶”ê°€
      formData.append("request_user_name", "{{ user.name }}");
      formData.append("request_user_branch", "{{ user.branch }}");
      formData.append("request_user_id", "{{ user.id }}");
      formData.append("request_user_enter", "{{ user.enter|date:'Y-m-d'|default:'' }}");

      // âœ… FormData ë‚´ìš© ë””ë²„ê·¸ ì¶œë ¥
      console.log("ğŸ§¾ ìµœì¢… ì „ì†¡ FormData:");
      console.table([...formData.entries()]);

      // âœ… Djangoë¡œ ì „ì†¡
      const response = await fetch("{% url 'generate_request_pdf' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      });

      if (!response.ok) throw new Error("PDF ìƒì„± ì‹¤íŒ¨");

      // âœ… PDF ìë™ ë‹¤ìš´ë¡œë“œ
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ì—…ë¬´ìš”ì²­ì„œ.pdf";
      a.click();
      window.URL.revokeObjectURL(url);

      console.log("âœ… PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
    } catch (err) {
      alert("PDF ì œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
      console.error("âŒ ì˜¤ë¥˜:", err);
    } finally {
      overlay.style.display = "none";
    }
  });
});
</script>


{% endblock %}
