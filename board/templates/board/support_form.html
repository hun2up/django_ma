{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}ì—…ë¬´ìš”ì²­ì„œ{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 800px;">
    <h3 class="mb-4 text-center fw-bold" style="color:#003f7d;">ì—…ë¬´ìš”ì²­ì„œ</h3>

    <div class="card shadow p-4 border-0 rounded-4">
      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- âœ… ìš”ì²­ ëŒ€ìƒ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold mb-0" style="color:#003f7d;">ìš”ì²­ëŒ€ìƒ</h6>
          <button type="button" id="resetUserBtn" class="btn btn-outline-secondary btn-sm">
            ì´ˆê¸°í™”
          </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3 align-items-end">
          <div class="col-md-1 text-center">
            <button type="button" class="btn btn-sm btn-primary search-btn" 
                    data-row="{{ i }}" data-bs-toggle="modal" data-bs-target="#searchUserModal">
              ê²€ìƒ‰
            </button>
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">ì„±ëª…</label>
            <input type="text" name="target_name_{{ i }}" class="form-control">
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">ì‚¬ë²ˆ</label>
            <input type="text" name="target_code_{{ i }}" class="form-control">
          </div>
          <div class="col-md-2 mb-2">
            <label class="form-label">ì…ì‚¬ì¼</label>
            <input type="date" name="target_join_{{ i }}" class="form-control">
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">í‡´ì‚¬ì¼</label>
            <input type="date" name="target_leave_{{ i }}" class="form-control">
          </div>
        </div>
        {% endfor %}

        <hr>

        <!-- âœ… ê³„ì•½ì‚¬í•­ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0" style="color:#005BAC;">ê³„ì•½ì‚¬í•­</h6>
        <button type="button" id="resetContractBtn" class="btn btn-outline-secondary btn-sm">
            ì´ˆê¸°í™”
        </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3">
        <div class="col-md-3 mb-2">
            <label class="form-label">ë³´í—˜ì‚¬</label>
            <input type="text" name="insurer_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ì¦ê¶Œë²ˆí˜¸</label>
            <input type="text" name="policy_no_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ê³„ì•½ì(í”¼ë³´í—˜ì)</label>
            <input type="text" name="contractor_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">ë³´í—˜ë£Œ</label>
            <input type="text" name="premium_{{ i }}" class="form-control">
        </div>
        </div>
        {% endfor %}

        <hr>

        <!-- âœ… ìš”ì²­ ë‚´ìš© -->
        <h6 class="fw-bold mb-3" style="color:#005BAC;">ìš”ì²­ ë‚´ìš©</h6>
        <div class="mb-3">
          <label class="form-label">ì œëª©</label>
          <input type="text" name="title" class="form-control" placeholder="ì œëª© ì…ë ¥">
        </div>
        <div class="mb-4">
          <label class="form-label">ë‚´ìš©</label>
          <textarea name="content" class="form-control" rows="5" placeholder="ìš”ì²­ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
        </div>

        <!-- âœ… ë²„íŠ¼ -->
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4">ë’¤ë¡œê°€ê¸°</a>
          <button type="button" id="generatePdfBtn" class="btn btn-primary px-5 fw-bold">ì œì‘í•˜ê¸°</button>
        </div>

        <!-- âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loadingOverlay" 
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(255,255,255,0.85); z-index:9999; text-align:center;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
            <div class="spinner-border text-primary" role="status" style="width:4rem; height:4rem;">
            <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3 fw-bold" style="color:#005BAC;">ì œì‘ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</h5>
        </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… ëŒ€ìƒì ê²€ìƒ‰ ëª¨ë‹¬ -->
<div class="modal fade" id="searchUserModal" tabindex="-1" aria-labelledby="searchUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h6 class="modal-title fw-bold" id="searchUserModalLabel">ëŒ€ìƒì ê²€ìƒ‰</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="searchUserForm" class="d-flex gap-2">
          <input type="text" class="form-control" id="searchKeyword" name="q" placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì„±ëª… ì…ë ¥">
          <button type="submit" class="btn btn-primary flex-shrink-0">ê²€ìƒ‰</button>
        </form>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Ajax ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
let currentRow = null;

// ê° í–‰ë³„ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ í–‰ ë²ˆí˜¸ ì €ì¥
document.querySelectorAll('.search-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    currentRow = this.dataset.row;
  });
});

document.getElementById('searchUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const query = document.getElementById('searchKeyword').value.trim();
  const resultsBox = document.getElementById('searchResults');
  resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ì¤‘...</p>';

  fetch(`/board/search-user/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      resultsBox.innerHTML = '';
      if (data.results.length === 0) {
        resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const list = document.createElement('div');
      list.classList.add('list-group');

      data.results.forEach(user => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <span><strong>${user.name}</strong> (${user.id}) (${user.regist})</span>
                <small class="text-muted">${user.branch}</small>
            </div>
            <small class="text-muted">ì…ì‚¬ì¼: ${user.enter || '-'} / í‡´ì‚¬ì¼: ${user.quit || '-'}</small>
            `;

        // âœ… ì„ íƒ ì‹œ í˜„ì¬ í–‰ì— ì±„ì›Œë„£ê¸°
        item.addEventListener('click', () => {
          if (!currentRow) return;
          document.querySelector(`input[name="target_name_${currentRow}"]`).value = user.name;
          document.querySelector(`input[name="target_code_${currentRow}"]`).value = user.code || user.regist || user.id;
          document.querySelector(`input[name="target_join_${currentRow}"]`).value = user.join_date || user.enter || '';
          document.querySelector(`input[name="target_leave_${currentRow}"]`).value = user.leave_date || user.quit || '';

          bootstrap.Modal.getInstance(document.getElementById('searchUserModal')).hide();
        });

        list.appendChild(item);
      });

      resultsBox.appendChild(list);
    })
    .catch(() => {
      resultsBox.innerHTML = '<p class="text-danger small text-center">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    });
});
</script>

<style>
  /* ê²€ìƒ‰ ë²„íŠ¼ ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì • */
  .search-btn {
    margin-top: -30px; /* ğŸ”¹ ìœ„ë¡œ ì‚´ì§ ì˜¬ë¦¼ (í•„ìš”ì— ë”°ë¼ -4~-8px ì¡°ì •) */
  }
</style>

<script>
  // âœ… ëª¨ë‹¬ ë‹«ì•˜ë‹¤ ë‹¤ì‹œ ì—´ ë•Œ ê²€ìƒ‰ì–´ì™€ ê²°ê³¼ ì´ˆê¸°í™”
  const searchModal = document.getElementById('searchUserModal');
  searchModal.addEventListener('show.bs.modal', function () {
    document.getElementById('searchKeyword').value = ''; // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
    document.getElementById('searchResults').innerHTML = ''; // ê²°ê³¼ ì´ˆê¸°í™”
  });
</script>

<script>
  // âœ… ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë“  ëŒ€ìƒì ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
  document.getElementById('resetUserBtn').addEventListener('click', function () {
    document.querySelectorAll('input[name^="target_name_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="target_code_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="target_join_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="target_leave_"]').forEach(el => el.value = '');
  });
</script>

<script>
  // âœ… ê³„ì•½ì‚¬í•­ ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë“  ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
  document.getElementById('resetContractBtn').addEventListener('click', function () {
    document.querySelectorAll('input[name^="insurer_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="policy_no_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="contractor_"]').forEach(el => el.value = '');
    document.querySelectorAll('input[name^="premium_"]').forEach(el => el.value = '');
  });
</script>

<script>
document.getElementById('generatePdfBtn').addEventListener('click', function() {
  const form = document.querySelector('form');
  const formData = new FormData(form);

  fetch('/board/generate-pdf/', {
    method: 'POST',
    body: formData,
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
  })
  .then(res => {
    if (!res.ok) throw new Error("PDF ìƒì„± ì‹¤íŒ¨");
    return res.blob();
  })
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ì—…ë¬´ìš”ì²­ì„œ.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();
  })
  .catch(err => alert("PDF ì œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
});
</script>

<script>
document.querySelector('form').addEventListener('submit', async function(e) {
  e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

  const form = this;
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'block'; // âœ… ë¡œë”©ì°½ í‘œì‹œ

  try {
    const formData = new FormData(form);
    const response = await fetch("{% url 'generate_pdf' %}", {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error("PDF ìƒì„± ì‹¤íŒ¨");

    // âœ… PDF ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "ì—…ë¬´ìš”ì²­ì„œ.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);

  } catch (err) {
    alert("PDF ì œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
    console.error(err);
  } finally {
    overlay.style.display = 'none'; // âœ… ì™„ë£Œ í›„ ë¡œë”©ì°½ ë‹«ê¸°
  }
});
</script>


{% endblock %}
