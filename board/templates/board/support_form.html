<!-- django_ma/board/templates/board/support_form.html -->
{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}ì—…ë¬´ìš”ì²­ì„œ{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 700px;">
    <h3 class="mb-4 text-center fw-bold" style="color:#003f7d;">ì—…ë¬´ìš”ì²­ì„œ</h3>

    <div class="card shadow p-4 border-0 rounded-4">
      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- âœ… ìš”ì²­ ëŒ€ìƒ (íƒ€ì´í‹€) -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0" style="color:#005BAC;">ìš”ì²­ëŒ€ìƒ</h5>
          <div>
            <button type="button" id="addUserBtn" class="btn btn-outline-primary btn-sm me-2">ì¶”ê°€</button>
            <button type="button" id="resetUserBtn" class="btn btn-outline-secondary btn-sm">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- âœ… ìš”ì²­ ëŒ€ìƒ (ë³¸ë¬¸) -->
        <div id="userContainer">
          {% for i in "12345" %}
          <div class="row mb-2 align-items-center user-row" data-index="{{ i }}" {% if i != "1" %}style="display:none;"{% endif %}>
            <div class="col-md-1 text-center">
              <button type="button" class="btn btn-sm btn-primary search-btn"
                      data-row="{{ i }}" data-bs-toggle="modal" data-bs-target="#searchUserModal">
                ê²€ìƒ‰
              </button>
            </div>

            <div class="col equal-field mb-2">
              <label class="form-label">ì„±ëª…</label>
              <input type="text" name="target_name_{{ i }}" class="form-control readonly-field">
            </div>
            <div class="col equal-field mb-2">
              <label class="form-label">ì‚¬ë²ˆ</label>
              <input type="text" name="target_code_{{ i }}" class="form-control readonly-field">
            </div>
            <div class="col equal-field mb-2">
              <label class="form-label">ì…ì‚¬ì¼</label>
              <input type="text" name="target_join_{{ i }}" class="form-control readonly-field"
                    onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            </div>
            <div class="col equal-field mb-2">
              <label class="form-label">í‡´ì‚¬ì¼</label>
              <input type="text" name="target_leave_{{ i }}" class="form-control readonly-field">
            </div>

            <!-- âœ… ì‚­ì œ ë²„íŠ¼ (1í–‰ì€ ë¹„í™œì„±í™”) -->
            <div class="col-md-1 text-center">
              {% if i != "1" %}
                <button type="button" class="btn btn-sm btn-outline-danger remove-user-btn" data-index="{{ i }}">ì œê±°</button>
              {% else %}
                <div style="height:32px;"></div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <hr>

        <!-- âœ… ê³„ì•½ì‚¬í•­(íƒ€ì´í‹€) -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0" style="color:#005BAC;">ê³„ì•½ì‚¬í•­</h5>
          <div>
            <button type="button" id="addContractBtn" class="btn btn-outline-primary btn-sm me-2">ì¶”ê°€</button>
            <button type="button" id="resetContractBtn" class="btn btn-outline-secondary btn-sm">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- âœ… ê³„ì•½ì‚¬í•­(ë³¸ë¬¸) -->
        <div id="contractContainer">
          {% for i in "12345" %}
          <div class="row mb-2 contract-row" data-index="{{ i }}" {% if i != "1" %}style="display:none;"{% endif %}>
            <div class="col-md-2 mb-2">
              <label class="form-label">ë³´í—˜ì‚¬</label>
              <input type="text" name="insurer_{{ i }}" class="form-control">
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">ì¦ê¶Œë²ˆí˜¸</label>
              <input type="text" name="policy_no_{{ i }}" class="form-control">
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">ê³„ì•½ì(í”¼ë³´í—˜ì)</label>
              <input type="text" name="contractor_{{ i }}" class="form-control">
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">ë³´í—˜ë£Œ</label>
              <input type="text" name="premium_{{ i }}" class="form-control">
            </div>

            <!-- âœ… ì‚­ì œ ë²„íŠ¼ (1í–‰ì€ ë¹„í™œì„±í™”) -->
            <div class="col-md-1 text-center">
              {% if i != "1" %}
                <button type="button" class="btn btn-sm btn-outline-danger remove-contract-btn" data-index="{{ i }}">ì œê±°</button>
              {% else %}
                <div style="height:32px;"></div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <hr>

        <!-- âœ… ìš”ì²­ ë‚´ìš© -->
        <h5 class="fw-bold mb-3" style="color:#005BAC;">ìš”ì²­ë‚´ìš©</h5>
        <div class="mb-3">
          <label class="form-label">ì œëª©</label>
          <input type="text" name="title" class="form-control" placeholder="ì œëª© ì…ë ¥">
        </div>
        <div class="mb-4">
          <label class="form-label">ë‚´ìš©</label>
          <textarea name="content" class="form-control" rows="5" placeholder="ìš”ì²­ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
        </div>

        <!-- âœ… ë²„íŠ¼ -->
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4">ë’¤ë¡œê°€ê¸°</a>
          <button type="button" id="generatePdfBtn" class="btn btn-primary px-5 fw-bold">ì œì‘í•˜ê¸°</button>
        </div>

        <!-- âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loadingOverlay" 
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(255,255,255,0.85); z-index:9999; text-align:center;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
            <div class="spinner-border text-primary" role="status" style="width:4rem; height:4rem;">
            <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3 fw-bold" style="color:#005BAC;">ì œì‘ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</h5>
        </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… ëŒ€ìƒì ê²€ìƒ‰ ëª¨ë‹¬ -->
<div class="modal fade" id="searchUserModal" tabindex="-1" aria-labelledby="searchUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h6 class="modal-title fw-bold" id="searchUserModalLabel">ëŒ€ìƒì ê²€ìƒ‰</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="searchUserForm" class="d-flex gap-2">
          <input type="text" class="form-control" id="searchKeyword" name="q" placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì„±ëª… ì…ë ¥">
          <button type="submit" class="btn btn-primary flex-shrink-0">ê²€ìƒ‰</button>
        </form>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* âœ… ë¼ë²¨ í¬ê¸° ì¡°ê¸ˆ ë” ì¤„ì´ê¸° */
  .form-label {
    font-size: 0.85rem;
  }

  /* âœ… ì¸í’‹ í•„ë“œ ê¸€ì”¨ í¬ê¸° ì‚´ì§ ì¤„ì´ê¸° */
  .form-control {
    font-size: 0.9rem;
  }
  
  .readonly-field {
    background-color: #f0f0f0 !important;
    pointer-events: none; /* í´ë¦­ë§Œ ë§‰ìŒ, ê°’ì€ ì „ì†¡ë¨ */
    color: #333;
    font-weight: 500;
  }

  .readonly-field:focus {
    outline: none;
    box-shadow: none;
  }

  .equal-field {
    flex: 1;
    min-width: 0;
  }

  /* âœ… ëª¨ë“  date ì…ë ¥ í•„ë“œ ê³µí†µ ì ìš© */
  input[type="date"] {
    color: transparent;                /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
    text-shadow: 0 0 0 #333;           /* ì…ë ¥ ì‹œì—” ì •ìƒ í‘œì‹œ */
    position: relative;
  }

  /* âœ… placeholderì²˜ëŸ¼ ë³´ì´ëŠ” ê¸°ë³¸ ì—°ë„-ì›”-ì¼ ë¬¸êµ¬ ì œê±° */
  input[type="date"]::before {
    content: "";
    color: transparent;
  }

  /* âœ… Chrome / Edge - ë‹¬ë ¥ ì•„ì´ì½˜ ì œê±° */
  input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    pointer-events: none;
  }

  /* âœ… ìˆ«ì ìŠ¤í•€ ë²„íŠ¼, ì´ˆê¸°í™” ë²„íŠ¼ ì œê±° */
  input[type="date"]::-webkit-inner-spin-button,
  input[type="date"]::-webkit-clear-button {
    display: none;
  }

  /* âœ… Firefox / Edge ëŒ€ì‘ */
  input[type="date"]::-ms-clear,
  input[type="date"]::-ms-expand {
    display: none;
  }

  /* âœ… ìš”ì²­ëŒ€ìƒ / ê³„ì•½ì‚¬í•­ì˜ ê° í–‰ ê°„ê²©ì„ ì¡°ê¸ˆ ì¢íˆê¸° */
  .row.mb-3 {
    margin-bottom: 0.6rem !important; /* ê¸°ë³¸ 1rem â†’ ì•½ 10pxë¡œ ì¶•ì†Œ */
  }

  /* âœ… ìš”ì²­ë‚´ìš©ê³¼ êµ¬ë¶„ë˜ëŠ” êµ¬íšì„ ë„ ì•½ê°„ ì¡°ì • */
  hr {
    margin: 0.8rem 0 !important; /* ìœ„ì•„ë˜ ê°„ê²© ì¶•ì†Œ */
  }

  /* âœ… ê³„ì•½ë‚´ìš©ì˜ ì œê±° ë²„íŠ¼ ìˆ˜ì§ ì •ë ¬ ì¡°ì • */
  .remove-contract-btn {
    margin-top: 24px; /* ë²„íŠ¼ì„ ì•„ë˜ë¡œ ì‚´ì§ ë‚´ë¦¼ (ì ì ˆí•œ ë†’ì´ê°’ ì¡°ì • ê°€ëŠ¥) */
  }
</style>

<script>
/* âœ… ìš”ì²­ëŒ€ìƒ / ê³„ì•½ì‚¬í•­ ì¶”ê°€ ê¸°ëŠ¥ */
document.addEventListener('DOMContentLoaded', () => {
  const userRows = document.querySelectorAll('.user-row');
  const contractRows = document.querySelectorAll('.contract-row');

  const addUserBtn = document.getElementById('addUserBtn');
  const addContractBtn = document.getElementById('addContractBtn');

  addUserBtn.addEventListener('click', () => {
    const hidden = Array.from(userRows).filter(r => r.style.display === 'none');
    if (hidden.length === 0) {
      alert('ìš”ì²­ëŒ€ìƒì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì¶”ê°€ ì…ë ¥ì´ í•„ìš”í•œ ê²½ìš° ì•„ë˜ ë‚´ìš© ì¹¸ì— ê¸°ì¬í•´ì£¼ì„¸ìš”.');
      return;
    }
    hidden[0].style.display = '';
  });

  addContractBtn.addEventListener('click', () => {
    const hidden = Array.from(contractRows).filter(r => r.style.display === 'none');
    if (hidden.length === 0) {
      alert('ê³„ì•½ì‚¬í•­ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì¶”ê°€ ì…ë ¥ì´ í•„ìš”í•œ ê²½ìš° ì•„ë˜ ë‚´ìš© ì¹¸ì— ê¸°ì¬í•´ì£¼ì„¸ìš”.');
      return;
    }
    hidden[0].style.display = '';
  });

    /* âœ… ì‚­ì œ ë²„íŠ¼ ë¡œì§ */
  document.querySelectorAll('.remove-user-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const index = btn.dataset.index;
      const row = document.querySelector(`.user-row[data-index="${index}"]`);
      if (!row) return;
      // ê°’ ì´ˆê¸°í™”
      row.querySelectorAll('input').forEach(el => el.value = '');
      // ìˆ¨ê¹€ ì²˜ë¦¬
      row.style.display = 'none';
    });
  });

  document.querySelectorAll('.remove-contract-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const index = btn.dataset.index;
      const row = document.querySelector(`.contract-row[data-index="${index}"]`);
      if (!row) return;
      row.querySelectorAll('input').forEach(el => el.value = '');
      row.style.display = 'none';
    });
  });
});
</script>


<!-- âœ… [1] ëŒ€ìƒì ê²€ìƒ‰ ë° ìë™ì…ë ¥ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - ëŒ€ìƒì ê²€ìƒ‰ ëª¨ë‹¬ì—ì„œ ê²€ìƒ‰ì–´ ì…ë ¥ í›„ ê²°ê³¼ í‘œì‹œ
 * - ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ í–‰ì˜ input í•„ë“œ ìë™ ì±„ì›€
 * - currentRow ë³€ìˆ˜ë¡œ í˜„ì¬ ì„ íƒëœ í–‰(row) ì¶”ì 
 */
let currentRow = null;

// ğŸ§© ê° í–‰ë³„ "ê²€ìƒ‰" ë²„íŠ¼ í´ë¦­ ì‹œ, ëª‡ ë²ˆì§¸ í–‰(row)ì¸ì§€ ì €ì¥
document.querySelectorAll('.search-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // ì˜ˆ: 1, 2, 3 ... ë²ˆì§¸ í–‰
    currentRow = this.dataset.row;
  });
});

// ğŸ§© ëª¨ë‹¬ ë‚´ ê²€ìƒ‰í¼ (ëŒ€ìƒì ê²€ìƒ‰ ì‹¤í–‰)
document.getElementById('searchUserForm').addEventListener('submit', function(e) {
  e.preventDefault(); // ê¸°ë³¸ form ì œì¶œ ë§‰ê¸°

  const query = document.getElementById('searchKeyword').value.trim(); // ì…ë ¥ëœ ê²€ìƒ‰ì–´
  const resultsBox = document.getElementById('searchResults'); // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­
  resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ì¤‘...</p>';

  // âœ… Django /board/search-user/ API í˜¸ì¶œ
  fetch(`/board/search-user/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      resultsBox.innerHTML = ''; // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”

      // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ
      if (data.results.length === 0) {
        resultsBox.innerHTML = '<p class="text-muted small text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // ê²€ìƒ‰ ê²°ê³¼ë¥¼ list-group í˜•íƒœë¡œ í‘œì‹œ
      const list = document.createElement('div');
      list.classList.add('list-group');

      data.results.forEach(user => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action';

        // ê²€ìƒ‰ ê²°ê³¼ UI ìƒì„±
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <span><strong>${user.name}</strong> (${user.id}) (${user.regist})</span>
                <small class="text-muted">${user.branch}</small>
            </div>
            <small class="text-muted">ì…ì‚¬ì¼: ${user.enter || '-'} / í‡´ì‚¬ì¼: ${user.quit || '-'}</small>
        `;

        // âœ… ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ â†’ í•´ë‹¹ í–‰ input ì±„ìš°ê¸°
        item.addEventListener('click', () => {
          if (!currentRow) return;

          const selectedCode = user.code || user.id || '';

          // âœ… ì¤‘ë³µ ê²€ì‚¬: ì´ë¯¸ ë“±ë¡ëœ ì‚¬ë²ˆì´ ìˆëŠ”ì§€ í™•ì¸
          const existingCodes = Array.from(document.querySelectorAll('input[name^="target_code_"]'))
            .map(input => input.value.trim())
            .filter(v => v !== '');

          if (existingCodes.includes(String(selectedCode))) {
            alert('âš ï¸ ì´ë¯¸ ì¶”ê°€ëœ ëŒ€ìƒìì…ë‹ˆë‹¤.');
            return; // ì¤‘ë³µì¼ ê²½ìš° ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
          }

          // í˜„ì¬ ì„ íƒëœ í–‰(row)ì— í•´ë‹¹í•˜ëŠ” input ìš”ì†Œë“¤ ì°¾ê¸°
          const nameInput = document.querySelector(`input[name="target_name_${currentRow}"]`);
          const codeInput = document.querySelector(`input[name="target_code_${currentRow}"]`);
          const joinInput = document.querySelector(`input[name="target_join_${currentRow}"]`);
          const leaveInput = document.querySelector(`input[name="target_leave_${currentRow}"]`);

          // DBì—ì„œ ë°›ì•„ì˜¨ ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
          nameInput.value = user.name || '';
          codeInput.value = selectedCode;
          joinInput.value = user.join_date || user.enter || '';

          // âœ… í‡´ì‚¬ì¼ì´ ì—†ìœ¼ë©´ "ì¬ì§ì¤‘" ìë™ í‘œì‹œ
          const leaveDate = user.leave_date || user.quit;
          leaveInput.value = leaveDate ? leaveDate : 'ì¬ì§ì¤‘';

          // âœ… ëª¨ë‹¬ ë‹«ê¸°
          bootstrap.Modal.getInstance(document.getElementById('searchUserModal')).hide();
        });

        list.appendChild(item);
      });

      resultsBox.appendChild(list);
    })
    .catch(() => {
      resultsBox.innerHTML = '<p class="text-danger small text-center">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    });
});
</script>

<!-- âœ… [2] ëª¨ë‹¬ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - ëª¨ë‹¬ì„ ë‹«ì•˜ë‹¤ ë‹¤ì‹œ ì—´ ë•Œ, ì´ì „ ê²€ìƒ‰ ê²°ê³¼ ë° ê²€ìƒ‰ì–´ë¥¼ ì´ˆê¸°í™”
 */
const searchModal = document.getElementById('searchUserModal');
searchModal.addEventListener('show.bs.modal', function () {
  // ê²€ìƒ‰ì°½ê³¼ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').innerHTML = '';
});
</script>

<!-- âœ… [3] ì´ˆê¸°í™” ë²„íŠ¼ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
/**
 * ğŸ¯ ê¸°ëŠ¥ ìš”ì•½:
 * - "ìš”ì²­ëŒ€ìƒ ì´ˆê¸°í™”" ë²„íŠ¼ í´ë¦­ ì‹œ â†’ ëŒ€ìƒì ì…ë ¥ í•„ë“œ ì „ì²´ ë¦¬ì…‹
 * - "ê³„ì•½ì‚¬í•­ ì´ˆê¸°í™”" ë²„íŠ¼ í´ë¦­ ì‹œ â†’ ë³´í—˜ì‚¬/ì¦ê¶Œë²ˆí˜¸/ê³„ì•½ì/ë³´í—˜ë£Œ í•„ë“œ ì „ì²´ ë¦¬ì…‹
 */

// âœ… ëŒ€ìƒì ì •ë³´ ì´ˆê¸°í™”
document.getElementById('resetUserBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="target_name_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_code_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_join_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_leave_"]').forEach(el => el.value = '');
});

// âœ… ê³„ì•½ì‚¬í•­ ì´ˆê¸°í™”
document.getElementById('resetContractBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="insurer_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="policy_no_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="contractor_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="premium_"]').forEach(el => el.value = '');
});
</script>

<!-- âœ… [4] PDF ìƒì„± ë° ì „ì†¡ ìŠ¤í¬ë¦½íŠ¸ (ì™„ì „ ìˆ˜ì • ë²„ì „) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const overlay = document.getElementById("loadingOverlay");
  const generateBtn = document.getElementById("generatePdfBtn");

  generateBtn.addEventListener("click", async function () {
    overlay.style.display = "block";

    try {
      // âœ… ê¸°ë³¸ FormData ìƒì„±
      const formData = new FormData();

      // âœ… ëª¨ë“  input, textarea, select ê°•ì œ ìˆ˜ì§‘ (readonly í¬í•¨)
      document.querySelectorAll("input, textarea, select").forEach((el) => {
        if (el.name) {
          const val = el.value || "";
          formData.append(el.name, val);
          console.log(`ğŸ“© ì¶”ê°€ë¨ â†’ ${el.name}: ${val}`);
        }
      });

      // âœ… ìš”ì²­ì ì •ë³´ ì¶”ê°€
      formData.append("request_user_name", "{{ user.name }}");
      formData.append("request_user_branch", "{{ user.branch }}");
      formData.append("request_user_id", "{{ user.id }}");
      formData.append("request_user_enter", "{{ user.enter|date:'Y-m-d'|default:'' }}");

      // âœ… FormData ë‚´ìš© ë””ë²„ê·¸ ì¶œë ¥
      console.log("ğŸ§¾ ìµœì¢… ì „ì†¡ FormData:");
      console.table([...formData.entries()]);

      // âœ… Djangoë¡œ ì „ì†¡
      const response = await fetch("{% url 'generate_request_pdf' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      });

      if (!response.ok) throw new Error("PDF ìƒì„± ì‹¤íŒ¨");

      // âœ… PDF ìë™ ë‹¤ìš´ë¡œë“œ
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ì—…ë¬´ìš”ì²­ì„œ.pdf";
      a.click();
      window.URL.revokeObjectURL(url);

      console.log("âœ… PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
    } catch (err) {
      alert("PDF ì œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
      console.error("âŒ ì˜¤ë¥˜:", err);
    } finally {
      overlay.style.display = "none";
    }
  });
});
</script>

<script>
/* âœ… ë³´í—˜ë£Œ ì…ë ¥ ì‹œ ìˆ«ìë§Œ + ì²œë‹¨ìœ„ ì½¤ë§ˆ ìë™ ì ìš© */
document.addEventListener('DOMContentLoaded', function() {
  const premiumInputs = document.querySelectorAll('input[name^="premium_"]');

  premiumInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      // 1. ìˆ«ì ì´ì™¸ ì œê±°
      let value = this.value.replace(/[^0-9]/g, '');
      // 2. ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
      if (value) {
        value = parseInt(value, 10).toLocaleString('ko-KR');
      }
      this.value = value;
    });

    // 3. ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ì‹œ ìˆ«ìë§Œ ìœ ì§€
    input.addEventListener('paste', function(e) {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      const numeric = text.replace(/[^0-9]/g, '');
      this.value = parseInt(numeric || 0, 10).toLocaleString('ko-KR');
    });
  });
});
</script>

{% endblock %}
