<!-- django_ma/board/templates/board/support_form.html -->
{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}업무요청서{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 800px;">
    <h3 class="mb-4 text-center fw-bold" style="color:#003f7d;">업무요청서</h3>

    <div class="card shadow p-4 border-0 rounded-4">
      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- ✅ 요청 대상 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold mb-0" style="color:#003f7d;">요청대상</h6>
          <button type="button" id="resetUserBtn" class="btn btn-outline-secondary btn-sm">
            초기화
          </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3 align-items-center">
          <!-- 검색 버튼 -->
          <div class="col-md-1 text-center">
            <button type="button" class="btn btn-sm btn-primary search-btn"
                    style="margin-top:-4px;"
                    data-row="{{ i }}" data-bs-toggle="modal" data-bs-target="#searchUserModal">
              검색
            </button>
          </div>

          <!-- 회색 비활성 필드 -->
          <div class="col equal-field mb-2">
            <label class="form-label">성명</label>
            <input type="text" name="target_name_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">사번</label>
            <input type="text" name="target_code_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">입사일</label>
            <input type="date" name="target_join_{{ i }}" class="form-control readonly-field">
          </div>
          <div class="col equal-field mb-2">
            <label class="form-label">퇴사일</label>
            <input type="text" name="target_leave_{{ i }}" class="form-control readonly-field">
          </div>
        </div>
        {% endfor %}

        <hr>

        <!-- ✅ 계약사항 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0" style="color:#005BAC;">계약사항</h6>
        <button type="button" id="resetContractBtn" class="btn btn-outline-secondary btn-sm">
            초기화
        </button>
        </div>

        {% for i in "12345" %}
        <div class="row mb-3">
        <div class="col-md-3 mb-2">
            <label class="form-label">보험사</label>
            <input type="text" name="insurer_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">증권번호</label>
            <input type="text" name="policy_no_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">계약자(피보험자)</label>
            <input type="text" name="contractor_{{ i }}" class="form-control">
        </div>
        <div class="col-md-3 mb-2">
            <label class="form-label">보험료</label>
            <input type="text" name="premium_{{ i }}" class="form-control">
        </div>
        </div>
        {% endfor %}

        <hr>

        <!-- ✅ 요청 내용 -->
        <h6 class="fw-bold mb-3" style="color:#005BAC;">요청 내용</h6>
        <div class="mb-3">
          <label class="form-label">제목</label>
          <input type="text" name="title" class="form-control" placeholder="제목 입력">
        </div>
        <div class="mb-4">
          <label class="form-label">내용</label>
          <textarea name="content" class="form-control" rows="5" placeholder="요청 상세 내용을 입력해주세요"></textarea>
        </div>

        <!-- ✅ 버튼 -->
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4">뒤로가기</a>
          <button type="button" id="generatePdfBtn" class="btn btn-primary px-5 fw-bold">제작하기</button>
        </div>

        <!-- ✅ 로딩 오버레이 -->
        <div id="loadingOverlay" 
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(255,255,255,0.85); z-index:9999; text-align:center;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
            <div class="spinner-border text-primary" role="status" style="width:4rem; height:4rem;">
            <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3 fw-bold" style="color:#005BAC;">제작 중입니다... 잠시만 기다려주세요.</h5>
        </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ 대상자 검색 모달 -->
<div class="modal fade" id="searchUserModal" tabindex="-1" aria-labelledby="searchUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h6 class="modal-title fw-bold" id="searchUserModalLabel">대상자 검색</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="searchUserForm" class="d-flex gap-2">
          <input type="text" class="form-control" id="searchKeyword" name="q" placeholder="사번 또는 성명 입력">
          <button type="submit" class="btn btn-primary flex-shrink-0">검색</button>
        </form>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .readonly-field {
    background-color: #f0f0f0 !important; /* 회색 배경 */
    pointer-events: none; /* 클릭 차단 */
    color: #6c757d; /* 글씨 회색 */
  }

  .readonly-field:focus {
    outline: none;
    box-shadow: none;
  }

  .equal-field {
    flex: 1;
    min-width: 0;
  }
</style>

<style>
  .readonly-field {
    background-color: #f0f0f0 !important;
    pointer-events: none; /* 클릭만 막음, 값은 전송됨 */
    color: #333;
    font-weight: 500;
  }
</style>


<!-- ✅ [1] 대상자 검색 및 자동입력 관련 스크립트 -->
<script>
/**
 * 🎯 기능 요약:
 * - 대상자 검색 모달에서 검색어 입력 후 결과 표시
 * - 검색 결과 클릭 시 해당 행의 input 필드 자동 채움
 * - currentRow 변수로 현재 선택된 행(row) 추적
 */
let currentRow = null;

// 🧩 각 행별 "검색" 버튼 클릭 시, 몇 번째 행(row)인지 저장
document.querySelectorAll('.search-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // 예: 1, 2, 3 ... 번째 행
    currentRow = this.dataset.row;
  });
});

// 🧩 모달 내 검색폼 (대상자 검색 실행)
document.getElementById('searchUserForm').addEventListener('submit', function(e) {
  e.preventDefault(); // 기본 form 제출 막기

  const query = document.getElementById('searchKeyword').value.trim(); // 입력된 검색어
  const resultsBox = document.getElementById('searchResults'); // 검색 결과 표시 영역
  resultsBox.innerHTML = '<p class="text-muted small text-center">검색 중...</p>';

  // ✅ Django /board/search-user/ API 호출
  fetch(`/board/search-user/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      resultsBox.innerHTML = ''; // 기존 결과 초기화

      // 검색 결과가 없을 때
      if (data.results.length === 0) {
        resultsBox.innerHTML = '<p class="text-muted small text-center">검색 결과가 없습니다.</p>';
        return;
      }

      // 검색 결과를 list-group 형태로 표시
      const list = document.createElement('div');
      list.classList.add('list-group');

      data.results.forEach(user => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action';

        // 검색 결과 UI 생성
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <span><strong>${user.name}</strong> (${user.id}) (${user.regist})</span>
                <small class="text-muted">${user.branch}</small>
            </div>
            <small class="text-muted">입사일: ${user.enter || '-'} / 퇴사일: ${user.quit || '-'}</small>
        `;

        // ✅ 검색 결과 클릭 시 → 해당 행 input 채우기
        item.addEventListener('click', () => {
          if (!currentRow) return;

          // 현재 선택된 행(row)에 해당하는 input 요소들 찾기
          const nameInput = document.querySelector(`input[name="target_name_${currentRow}"]`);
          const codeInput = document.querySelector(`input[name="target_code_${currentRow}"]`);
          const joinInput = document.querySelector(`input[name="target_join_${currentRow}"]`);
          const leaveInput = document.querySelector(`input[name="target_leave_${currentRow}"]`);

          // DB에서 받아온 값으로 입력 필드 채우기
          nameInput.value = user.name || '';
          codeInput.value = user.code || user.id || '';
          joinInput.value = user.join_date || user.enter || '';

          // ✅ 퇴사일이 없으면 "재직중" 자동 표시
          const leaveDate = user.leave_date || user.quit;
          leaveInput.value = leaveDate ? leaveDate : '재직중';

          // ✅ 모달 닫기
          bootstrap.Modal.getInstance(document.getElementById('searchUserModal')).hide();
        });

        list.appendChild(item);
      });

      resultsBox.appendChild(list);
    })
    .catch(() => {
      resultsBox.innerHTML = '<p class="text-danger small text-center">검색 중 오류가 발생했습니다.</p>';
    });
});
</script>

<!-- ✅ [2] 모달 초기화 스크립트 -->
<script>
/**
 * 🎯 기능 요약:
 * - 모달을 닫았다 다시 열 때, 이전 검색 결과 및 검색어를 초기화
 */
const searchModal = document.getElementById('searchUserModal');
searchModal.addEventListener('show.bs.modal', function () {
  // 검색창과 결과 리스트 초기화
  document.getElementById('searchKeyword').value = '';
  document.getElementById('searchResults').innerHTML = '';
});
</script>

<!-- ✅ [3] 초기화 버튼 관련 스크립트 -->
<script>
/**
 * 🎯 기능 요약:
 * - "요청대상 초기화" 버튼 클릭 시 → 대상자 입력 필드 전체 리셋
 * - "계약사항 초기화" 버튼 클릭 시 → 보험사/증권번호/계약자/보험료 필드 전체 리셋
 */

// ✅ 대상자 정보 초기화
document.getElementById('resetUserBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="target_name_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_code_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_join_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="target_leave_"]').forEach(el => el.value = '');
});

// ✅ 계약사항 초기화
document.getElementById('resetContractBtn').addEventListener('click', function () {
  document.querySelectorAll('input[name^="insurer_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="policy_no_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="contractor_"]').forEach(el => el.value = '');
  document.querySelectorAll('input[name^="premium_"]').forEach(el => el.value = '');
});
</script>

<!-- ✅ [4] PDF 생성 및 전송 스크립트 (완전 수정 버전) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const overlay = document.getElementById("loadingOverlay");
  const generateBtn = document.getElementById("generatePdfBtn");

  generateBtn.addEventListener("click", async function () {
    overlay.style.display = "block";

    try {
      // ✅ 기본 FormData 생성
      const formData = new FormData();

      // ✅ 모든 input, textarea, select 강제 수집 (readonly 포함)
      document.querySelectorAll("input, textarea, select").forEach((el) => {
        if (el.name) {
          const val = el.value || "";
          formData.append(el.name, val);
          console.log(`📩 추가됨 → ${el.name}: ${val}`);
        }
      });

      // ✅ 요청자 정보 추가
      formData.append("request_user_name", "{{ user.name }}");
      formData.append("request_user_branch", "{{ user.branch }}");
      formData.append("request_user_id", "{{ user.id }}");
      formData.append("request_user_enter", "{{ user.enter|date:'Y-m-d'|default:'' }}");

      // ✅ FormData 내용 디버그 출력
      console.log("🧾 최종 전송 FormData:");
      console.table([...formData.entries()]);

      // ✅ Django로 전송
      const response = await fetch("{% url 'generate_request_pdf' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      });

      if (!response.ok) throw new Error("PDF 생성 실패");

      // ✅ PDF 자동 다운로드
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "업무요청서.pdf";
      a.click();
      window.URL.revokeObjectURL(url);

      console.log("✅ PDF 다운로드 완료");
    } catch (err) {
      alert("PDF 제작 중 오류가 발생했습니다. 관리자에게 문의하세요.");
      console.error("❌ 오류:", err);
    } finally {
      overlay.style.display = "none";
    }
  });
});
</script>


{% endblock %}
