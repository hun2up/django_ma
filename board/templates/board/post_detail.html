{% extends "base.html" %}
{% load static %}

{% block title %}업무요청 상세보기{% endblock %}

{% block content %}
<div class="container mt-5">

  {% if messages %}
    <div class="container mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show text-center" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="mx-auto" style="max-width: 700px;">
    <div class="card shadow p-4 border-0 rounded-4">

      <!-- 제목 + 작성일자 -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0" style="color:#003f7d;">{{ post.title }}</h5>
        <p class="text-muted small mb-0">{{ post.created_at|date:"Y-m-d H:i" }}</p>
      </div>

      <!-- 요청 내용 -->
      <div class="mb-4 mt-3 p-3 rounded-3" style="background-color: #f8f9fa;">
        <p class="fs-6 mb-0" style="white-space: pre-wrap; line-height: 1.7;">
          {{ post.content }}
        </p>
      </div>

      <hr class="mt-4 mb-3">

      <!-- 필드 요약 정보 -->
      <div class="mb-3 small">
        <div class="row">
          <div class="col-md-4 mb-2"><strong class="text-muted">구분:</strong> {{ post.category|default:"-" }}</div>
          <div class="col-md-4 mb-2"><strong class="text-muted">성명(대상자):</strong> {{ post.fa|default:"-" }}</div>
          <div class="col-md-4 mb-2"><strong class="text-muted">사번(대상자):</strong> {{ post.code|default:"-" }}</div>
          <div class="col-md-4 mb-2"><strong class="text-muted">소속(요청자):</strong> {{ post.user_branch }}</div>
          <div class="col-md-4 mb-2"><strong class="text-muted">성명(요청자):</strong> {{ post.user_name }}</div>
          <div class="col-md-4 mb-2"><strong class="text-muted">요청자(사번):</strong> {{ post.user_id }}</div>
        </div>
      </div>

      <!-- 담당자, 상태, 상태변경일 -->
      <hr class="my-3">
      <div class="mb-3">
        <div class="row align-items-center">

          <!-- 담당자 -->
          <div class="col-md-4 mb-2">
            <strong class="text-muted">담당자:</strong>
            {% if is_superuser %}
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="handler">
                <select name="handler" class="form-select form-select-sm d-inline-block" style="width:auto;">
                  <option value="선택" {% if not post.handler %}selected{% endif %}>선택</option>
                  {% for h in handlers %}
                    <option value="{{ h }}" {% if post.handler == h %}selected{% endif %}>{{ h }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">변경</button>
              </form>
            {% else %}
              {{ post.handler|default:"-" }}
            {% endif %}
          </div>

          <!-- 상태 -->
          <div class="col-md-4 mb-2">
            <strong class="text-muted">상태:</strong>
            {% if is_superuser %}
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="status">
                <select name="status" class="form-select form-select-sm status-select d-inline-block" style="width:auto;">
                  {% for s in status_choices %}
                    <option value="{{ s }}"
                      {% if post.status == s %}selected{% endif %}
                      data-color="{% if s == '확인중' %}orange{% elif s == '진행중' %}green{% elif s == '보완요청' %}red{% elif s == '완료' %}black{% elif s == '반려' %}gray{% endif %}">
                      {{ s }}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">변경</button>
              </form>
            {% else %}
              <span
                style="
                  {% if post.status == '확인중' %}color:orange;
                  {% elif post.status == '진행중' %}color:green;
                  {% elif post.status == '보완요청' %}color:red;
                  {% elif post.status == '완료' %}color:black;
                  {% elif post.status == '반려' %}color:gray;
                  {% endif %}
                  font-weight:600;">
                {{ post.status }}
              </span>
            {% endif %}
          </div>

          <!-- 상태변경일 -->
          <div class="col-md-4 mb-2">
            <strong class="text-muted">상태변경일:</strong> {{ post.status_updated_at|date:"Y-m-d H:i" }}
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'post_list' %}" class="btn btn-outline-secondary">← 목록으로</a>
        <a href="{% url 'home' %}" class="btn btn-dark">메인으로</a>
      </div>

    </div>
  </div>
</div>
{% endblock %}
