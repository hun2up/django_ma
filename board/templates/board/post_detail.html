<!--django_ma/board/templates/board/post_detail.html-->
{% extends "base.html" %}
{% load static %}

{% block title %}업무요청 상세보기{% endblock %}

{% block content %}
<div class="container mt-5">

  {% if messages %}
    <div class="container mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show text-center" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="mx-auto" style="max-width: 700px;">
    <div class="card shadow p-4 border-0 rounded-4">

      <!-- 공통 CSS 불러오기 -->
      <link rel="stylesheet" href="{% static 'css/label-style.css' %}">

      <!-- 제목 + 작성일자 -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0" style="color:#003f7d;">{{ post.title }}</h5>
        <p class="text-muted small mb-0">{{ post.created_at|date:"Y-m-d H:i" }}</p>
      </div>

      <!-- 요청 내용 -->
      <div class="mb-4 mt-3 p-3 rounded-3" style="background-color: #f8f9fa;">
        <p class="fs-6 mb-0" style="white-space: pre-wrap; line-height: 1.7;">
          {{ post.content }}
        </p>
      </div>

      <hr class="mt-4 mb-3">

      <!-- 필드 요약 정보 -->
      <div class="mb-3">
        <div class="row gy-2 gx-3">

          <div class="col-md-4">
            <span class="info-label">구분</span>
            <span class="info-value">{{ post.category|default:"-" }}</span>
          </div>

          <div class="col-md-4">
            <span class="info-label">성명(대상자)</span>
            <span class="info-value">{{ post.fa|default:"-" }}</span>
          </div>

          <div class="col-md-4">
            <span class="info-label">사번(대상자)</span>
            <span class="info-value">{{ post.code|default:"-" }}</span>
          </div>

          <div class="col-md-4">
            <span class="info-label">소속(요청자)</span>
            <span class="info-value">{{ post.user_branch }}</span>
          </div>

          <div class="col-md-4">
            <span class="info-label">성명(요청자)</span>
            <span class="info-value">{{ post.user_name }}</span>
          </div>

          <div class="col-md-4">
            <span class="info-label">사번(요청자)</span>
            <span class="info-value">{{ post.user_id }}</span>
          </div>
        </div>
      </div>

      <!-- 담당자, 상태, 상태변경일 -->
      <hr class="my-3">
      <div class="mb-3">
        <div class="row align-items-center">

          <!-- 담당자 -->
          <div class="col-md-4 mb-2">
            <span class="info-label">담당자</span>
            {% if is_superuser %}
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="handler">
                <select name="handler" class="form-select form-select-sm d-inline-block" style="width:auto;">
                  <option value="선택" {% if not post.handler %}selected{% endif %}>선택</option>
                  {% for h in handlers %}
                    <option value="{{ h }}" {% if post.handler == h %}selected{% endif %}>{{ h }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">변경</button>
              </form>
            {% else %}
              {{ post.handler|default:"-" }}
            {% endif %}
          </div>

          <!-- 상태 -->
          <div class="col-md-4 mb-2">
            <span class="info-label">상태</span>
            {% if is_superuser %}
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="status">
                <select name="status" class="form-select form-select-sm status-select d-inline-block" style="width:auto;">
                  {% for s in status_choices %}
                    <option value="{{ s }}"
                      {% if post.status == s %}selected{% endif %}
                      data-color="{% if s == '확인중' %}orange{% elif s == '진행중' %}green{% elif s == '보완요청' %}red{% elif s == '완료' %}black{% elif s == '반려' %}gray{% endif %}">
                      {{ s }}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">변경</button>
              </form>
            {% else %}
              <span
                style="
                  {% if post.status == '확인중' %}color:orange;
                  {% elif post.status == '진행중' %}color:green;
                  {% elif post.status == '보완요청' %}color:red;
                  {% elif post.status == '완료' %}color:black;
                  {% elif post.status == '반려' %}color:gray;
                  {% endif %}
                  font-weight:600;">
                {{ post.status }}
              </span>
            {% endif %}
          </div>

          <!-- 상태변경일 -->
          <div class="col-md-4 mb-2">
            <span class="info-label">상태변경</span> <span class="small-text">{{ post.status_updated_at|date:"Y-m-d H:i" }}</span>
          </div>
        </div>

        <hr class="my-3">

        {% if post.attachments.exists %}
          <div class="mt-4">
            <span class="info-value">첨부파일</span>
            <ul class="list-group">
              {% for att in post.attachments.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div class="text-truncate" style="max-width: 80%;">
                    <i class="bi bi-paperclip"></i>
                    <a href="{{ att.file.url }}" download="{{ att.original_name|default:att.file.name }}">
                      {{ att.original_name|default:att.file.name }}
                    </a>
                  </div>
                  <span class="badge bg-light text-dark border">
                    {{ att.size|filesizeformat }}
                  </span>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>

      <div class="d-flex justify-content-between mt-4">
        <div class="d-flex gap-2">
          <a href="{% url 'post_list' %}" class="btn btn-outline-secondary">목록으로</a>

          {% if user.is_authenticated and user == post.author or user.is_superuser %}
            <!-- 수정 버튼 -->
            <a href="{% url 'post_edit' post.id %}" class="btn btn-outline-primary">수정하기</a>
          {% endif %}
        </div>

        <a href="{% url 'home' %}" class="btn btn-dark">메인으로</a>
      </div>

    </div>
  </div>
</div>
{% endblock %}
