<!-- django_ma/commission/templates/commission/deposit_home.html -->
{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}ì±„ê¶Œê´€ë¦¬{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 1100px;">
    <div class="card shadow p-4 border-0 rounded-4">

      <!-- ì œëª© -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0" style="color:#003f7d;">ì±„ê¶Œí˜„í™©</h5>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#searchUserModal">
            ëŒ€ìƒìê²€ìƒ‰
          </button>
          <button type="button" id="resetUserBtn" class="btn btn-outline-secondary btn-sm">
            ì´ˆê¸°í™”
          </button>
        </div>
      </div>

      <!-- âœ… ì¸ì ì‚¬í•­ -->
      <div class="info-section my-3">
        <div class="info-box">ì¸ì ì‚¬í•­</div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">ì‚¬ë²ˆ</span>
            <span class="info-value">
              {% if target %}{{ target.id }}{% else %}-{% endif %}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">ì„±ëª…</span>
            <span class="info-value">
              {% if target %}{{ target.name }}{% else %}-{% endif %}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">ì†Œì†</span>
            <span class="info-value">
              {% if target %}{{ target.branch|default:"-" }}{% else %}-{% endif %}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">ì…ì‚¬ì¼</span>
            <span class="info-value">
              {% if target %}{{ target.join_date_display }}{% else %}-{% endif %}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">í‡´ì‚¬ì¼</span>
            <span class="info-value">
              {% if target %}{{ target.retire_date_display }}{% else %}-{% endif %}
            </span>
          </div>
        </div>
      </div>


      <!-- ì£¼ìš”ì§€í‘œ -->
      <div class="info-section my-3">
        <div class="info-box">ì£¼ìš”ì§€í‘œ</div>

          <div class="info-row">
            <div class="info-item">
              <span class="info-label">ìµœì¢…ì§€ê¸‰ì•¡</span>
              <span class="info-value">
                {% if payment %}
                  {{ payment|floatformat:0|intcomma }}ì›
                {% else %}
                  -
                {% endif %}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">í™˜ìˆ˜ì˜ˆìƒ</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">ì§€ê¸‰ì˜ˆìƒ</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">í•„ìš”ì±„ê¶Œ</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">ìµœì¢…ì´ˆê³¼ê¸ˆì•¡</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
          </div>
          <div class="info-row">
            <div class="info-item">
              <span class="info-label">ì´ì±„ê¶Œí•©ê³„</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">ë³´ì¦í•©ê³„</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">ê¸°íƒ€í•©ê³„</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">25íšŒì†ë³´í†µì‚°</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
            <div class="info-item">
              <span class="info-label">25íšŒìƒë³´í†µì‚°</span>
              <span class="info-value">ì œì‘ì¤‘</span>
            </div>
          </div>
      </div>

      <!-- âœ… ìˆ˜ìˆ˜ë£Œ í˜„í™© -->
      <div class="info-section my-3">
        <div class="info-box">ìˆ˜ìˆ˜ë£Œí˜„í™©</div>

        <!-- ë¼ë°¸ (í™˜ìˆ˜ì˜ˆìƒìˆ˜ìˆ˜ë£Œ) -->
        <div class="info-row-label mt-3">
          <div class="info-cell"><span class="info-label">í™˜ìˆ˜ì†ë³´</span></div>
          <div class="info-cell"><span class="info-label">í™˜ìˆ˜ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)í™˜ìˆ˜ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)í™˜ìˆ˜ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)í™˜ìˆ˜í•©ê³„</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)í™˜ìˆ˜ì†ë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)í™˜ìˆ˜ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)í™˜ìˆ˜í•©ê³„</span></div>
        </div>

        <!-- ë°¸ë¥˜ (í™˜ìˆ˜ì˜ˆìƒìˆ˜ìˆ˜ë£Œ) -->
        <div class="info-row-value mt-2">
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
        </div>

        <!-- ë¼ë°¸ (ì§€ê¸‰ì˜ˆìƒìˆ˜ìˆ˜ë£Œ) -->
        <div class="info-row-label mt-3">
          <div class="info-cell"><span class="info-label">ì§€ê¸‰ì†ë³´</span></div>
          <div class="info-cell"><span class="info-label">ì§€ê¸‰ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)ì§€ê¸‰ì†ë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)ì§€ê¸‰ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(O)ì§€ê¸‰í•©ê³„</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)ì§€ê¸‰ì†ë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)ì§€ê¸‰ìƒë³´</span></div>
          <div class="info-cell"><span class="info-label">ë³´ì¦(X)ì§€ê¸‰í•©ê³„</span></div>
        </div>

        <!-- ë°¸ë¥˜ (ì§€ê¸‰ì˜ˆìƒìˆ˜ìˆ˜ë£Œ) -->
        <div class="info-row-value mt-2">
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
        </div>

        <hr class="my-3">

        <!-- ë¼ë°¸ (ì±„ê¶Œì¦ì•¡) -->
        <div class="info-row-label mt-3">
          <div class="info-cell"><span class="info-label">3ê°œì›”ì¥ê¸°ì´</span></div>
          <div class="info-cell"><span class="info-label">3ê°œì›”ì´ˆê³¼</span></div>
          <div class="info-cell"><span class="info-label">6ê°œì›”ì¥ê¸°ì´</span></div>
          <div class="info-cell"><span class="info-label">6ê°œì›”ì´ˆê³¼</span></div>
          <div class="info-cell"><span class="info-label">9ê°œì›”ì¥ê¸°ì´</span></div>
          <div class="info-cell"><span class="info-label">9ê°œì›”ì´ˆê³¼</span></div>
          <div class="info-cell"><span class="info-label">12ê°œì›”ì¥ê¸°ì´</span></div>
          <div class="info-cell"><span class="info-label">12ê°œì›”ì´ˆê³¼</span></div>
        </div>

        <!-- ë°¸ë¥˜ (ì±„ê¶Œì¦ì•¡) -->
        <div class="info-row-value mt-2">
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
        </div>
      </div>

      <!-- âœ… ìœ ì§€ìœ¨&ìˆ˜ê¸ˆìœ¨ í˜„í™© -->
      <div class="info-section my-3">
        <div class="info-box">ìˆ˜ìˆ˜ë£Œí˜„í™©</div>

        <!-- ë¼ë°¸ (ìœ ì§€ìœ¨&ìˆ˜ê¸ˆìœ¨) -->
        <div class="info-row-label mt-3">
          <div class="info-cell"><span class="info-label">13íšŒì†ë³´í†µì‚°</span></div>
          <div class="info-cell"><span class="info-label">18íšŒì†ë³´í†µì‚°</span></div>
          <div class="info-cell"><span class="info-label">13íšŒìƒë³´í†µì‚°</span></div>
          <div class="info-cell"><span class="info-label">18íšŒìƒë³´í†µì‚°</span></div>
          <div class="info-cell"><span class="info-label">2-6íšŒì†ë³´ì‘ë‹¹</span></div>
          <div class="info-cell"><span class="info-label">2-13íšŒì†ë³´ì‘ë‹¹</span></div>
          <div class="info-cell"><span class="info-label">2-6íšŒìƒë³´ì‘ë‹¹</span></div>
          <div class="info-cell"><span class="info-label">2-13íšŒìƒë³´ì‘ë‹¹</span></div>
        </div>

        <!-- ë°¸ë¥˜ (ìœ ì§€ìœ¨&ìˆ˜ê¸ˆìœ¨) -->
        <div class="info-row-value mt-2">
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
          <div class="info-cell"><span class="info-value">ì œì‘ì¤‘</span></div>
        </div>
      </div>

      <!-- ì±„ê¶Œì§€í‘œ -->
      <div class="info-section my-3">
        <div class="info-box">ì±„ê¶Œí˜„í™©</div>
        <span class="info-value">ë³´ì¦ë³´í—˜</span>
        <span class="info-value">ê¸°íƒ€ì±„ê¶Œ</span>
    </div>
  </div>
</div>

<!-- ë°ì´í„°ì—…ë¡œë“œ ì¹´ë“œ -->
<div class="container mt-5">
  <div class="mx-auto" style="max-width: 1100px;">
    <div class="card shadow p-4 border-0 rounded-4">

    <!-- ì œëª© -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold mb-0" style="color:#003f7d;">ë°ì´í„° ì—…ë°ì´íŠ¸</h5>
      <div class="d-flex gap-2 align-items-center">
        <!-- âœ… ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼ -->
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#excelUploadModal">
          ì—‘ì…€ì—…ë¡œë“œ
        </button>
      </div>
    </div>
  </div>
</div>


<!-- âœ… ì—‘ì…€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div class="modal fade" id="excelUploadModal" tabindex="-1" aria-labelledby="excelUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 border-0 shadow">
      <div class="modal-header bg-light">
        <h6 class="modal-title fw-bold" id="excelUploadModalLabel">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>

      <div class="modal-body">
        <form id="excelUploadForm" method="POST" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- âœ… ì—…ë¡œë“œ êµ¬ë¶„ (ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½) -->
          <div class="mb-3">
            <label class="form-label small fw-bold">ì—…ë¡œë“œ êµ¬ë¶„</label>
            <select id="uploadTypeSelect" name="upload_type" class="form-select form-select-sm" required>
              <option value="">-- ì„ íƒ --</option>
              <option value="ìµœì¢…ì§€ê¸‰ì•¡">ìµœì¢…ì§€ê¸‰ì•¡</option>
              <option value="í™˜ìˆ˜ì§€ê¸‰ì˜ˆìƒ">í™˜ìˆ˜ì§€ê¸‰ì˜ˆìƒ</option>
              <option value="ë³´ì¦ì¦ì•¡">ë³´ì¦ì¦ì•¡</option>
              <option value="ë³´ì¦ë³´í—˜">ë³´ì¦ë³´í—˜</option>
              <option value="ê¸°íƒ€ì±„ê¶Œ">ê¸°íƒ€ì±„ê¶Œ</option>
              <option value="í†µì‚°ìƒë³´">í†µì‚°ìƒë³´</option>
              <option value="í†µì‚°ì†ë³´">í†µì‚°ì†ë³´</option>
              <option value="ì‘ë‹¹ìƒë³´">ì‘ë‹¹ìƒë³´</option>
              <option value="ì‘ë‹¹ì†ë³´">ì‘ë‹¹ì†ë³´</option>
            </select>
          </div>

          <!-- âœ… íŒŒì¼ ì„ íƒ -->
          <div class="mb-3">
            <label for="excelFile" class="form-label small fw-bold">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
            <input class="form-control form-control-sm" type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
          </div>

          <div class="text-end mt-4">
            <button type="submit" class="btn btn-primary btn-sm">ì—…ë¡œë“œ</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          </div>
        </form>

        <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
        <div id="uploadResult" class="mt-3 small text-center"></div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… ì—…ë¡œë“œ ì™„ë£Œ í† ìŠ¤íŠ¸ -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="uploadToast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body fw-bold">âœ… ì—…ë¡œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchForm = document.getElementById('searchUserForm');
  const searchInput = document.getElementById('searchKeyword');
  const resultsBox = document.getElementById('searchResults');

  // âœ… í¼ ê¸°ë³¸ ì œì¶œ ë°©ì§€ + AJAX ê²€ìƒ‰
  searchForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const keyword = searchInput.value.trim();
    if (!keyword) {
      resultsBox.innerHTML = `<div class="text-danger fw-bold mt-2">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
      return;
    }

    try {
      const response = await fetch(`/commission/search-user/?q=${encodeURIComponent(keyword)}`);
      const data = await response.json();

      if (data.results && data.results.length > 0) {
        resultsBox.innerHTML = data.results.map(u => `
          <div class="search-card shadow-sm p-3 mb-2 rounded-3 d-flex justify-content-between align-items-center">
            <div class="card-info text-truncate">
              <span class="fw-bold text-dark">${u.name}</span>
              <small class="text-secondary">(${u.id})</small>
              <span class="text-muted">| ${u.branch || '-'}</span>
            </div>
            <a href="/commission/deposit/?user=${u.id}" class="btn btn-sm btn-primary px-3">ì„ íƒ</a>
          </div>
        `).join('');
      } else {
        resultsBox.innerHTML = `<div class="text-muted mt-2 text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }

    } catch (error) {
      console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", error);
      resultsBox.innerHTML = `<div class="text-danger mt-2 text-center">âš ï¸ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
    }
  });

  // âœ… ì—”í„°í‚¤ ì…ë ¥ ì‹œì—ë„ ë™ì¼ ë™ì‘
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchForm.dispatchEvent(new Event('submit'));
    }
  });
});
</script>

<script>
const searchInput = document.getElementById('searchKeyword');

// âœ… ì—”í„°í‚¤ë¡œë„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ê²Œ ì²˜ë¦¬
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë°©ì§€
    document.querySelector('#searchUserForm button[type="submit"]').click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹¤í–‰
  }
});
</script>

<script>
document.getElementById('resetUserBtn').addEventListener('click', function() {
  // ê¸°ë³¸ í˜ì´ì§€(ëŒ€ìƒì ë¯¸ì„ íƒ ìƒíƒœ)ë¡œ ì´ë™
  window.location.href = '/commission/deposit/';
});
</script>

<style>
  /* âœ… ëŒ€ìƒì ê²€ìƒ‰ ê²°ê³¼ í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
  #searchResults div {
    font-size: 0.85rem;
    line-height: 1.3;
  }

  #searchResults .btn {
    font-size: 0.85rem;
    padding: 3px 10px;
  }

  /* âœ… ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  #uploadTypeDropdown {
    min-width: 160px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* ê¸´ í…ìŠ¤íŠ¸ëŠ” â€¦ ì²˜ë¦¬ */
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const excelModal = document.getElementById('excelUploadModal');
  const uploadForm = document.getElementById('excelUploadForm');
  const resultBox = document.getElementById('uploadResult');

  // âœ… ëª¨ë‹¬ì´ ë‹«í ë•Œ ìë™ ì´ˆê¸°í™”
  excelModal.addEventListener('hidden.bs.modal', () => {
    uploadForm.reset(); // form ì´ˆê¸°í™” (ë“œë¡­ë‹¤ìš´ + íŒŒì¼)
    resultBox.innerHTML = ''; // ê²°ê³¼ ë©”ì‹œì§€ ì´ˆê¸°í™”
  });
});
</script>

<style>
/* ğŸ’³ ê²€ìƒ‰ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.search-card {
  border: 1px solid #e0e6ed;
  background-color: #fff;
  transition: all 0.25s ease;
}

.search-card:hover {
  background-color: #f8faff;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.15);
}

.search-card .card-info {
  flex-grow: 1;
}

.search-card .fw-bold {
  font-size: 0.95rem;
}

.search-card small {
  font-size: 0.8rem;
}

.search-card .text-muted {
  font-size: 0.8rem;
}
</style>

{% include 'components/search_user_modal.html' with search_url='/api/accounts/search-user/' %}

{% endblock %}
