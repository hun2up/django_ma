{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}수수료결재{% endblock %}

{% block content %}
<!-- =========================================================
  Approval Home (수수료 결재)
  - 기능 변경 없음
  - CSS 정합성 유지 (commission.css)
  - 가독성/유지보수 리팩토링 완료
========================================================== -->

<div class="container my-4">

  <!-- =========================
    Page Title
  ========================== -->
  <h3 class="text-center fw-bold mb-4" style="color:#003f7d;">
    수수료 결재 페이지
  </h3>

  <!-- =====================================================
    1) Search Controls (연 / 월 / 부서)
  ====================================================== -->
  <div class="card shadow p-3 border-0 rounded-4 mb-3 deposit-maxw mx-auto">
    <form id="controlsForm" class="row g-2 align-items-end" method="get">

      <!-- 연도 -->
      <div class="col-6 col-md-2">
        <label class="form-label mb-1">연도</label>
        <select name="year" class="form-select">
          {% for y in years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- 월 -->
      <div class="col-6 col-md-2">
        <label class="form-label mb-1">월도</label>
        <select name="month" class="form-select">
          {% for m in "123456789101112"|make_list %}
            <option value="{{ forloop.counter }}"
              {% if selected_month == forloop.counter %}selected{% endif %}>
              {{ forloop.counter|stringformat:"02d" }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 부서 -->
      <div class="col-12 col-md-4">
        <label class="form-label mb-1">부서</label>
        <select name="part" class="form-select">
          <option value="">전체</option>
          {% for p in parts %}
            <option value="{{ p }}" {% if p == selected_part %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- 조회 -->
      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-primary">조회</button>
      </div>

    </form>
  </div>

  <!-- =====================================================
    2) Result Tables
  ====================================================== -->
  <div class="card shadow p-3 border-0 rounded-4 deposit-maxw mx-auto">

    <!-- Excel Upload -->
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#approvalExcelUploadModal">
        엑셀업로드
      </button>
    </div>

    <!-- =========================
      2-1) 지점효율 초과
    ========================== -->
    <div class="text-center fw-bold mb-2">지점효율지급 초과현황</div>

    <div class="table-responsive commission-table-scroll">
      <table class="table table-bordered table-sm text-center commission-nowrap-table">
        <thead class="table-light">
          <tr>
            <th>부서</th><th>영업가족</th><th>성명</th><th>사번</th><th>지급합계</th>
          </tr>
        </thead>
        <tbody>
          {% for r in efficiency_rows %}
          <tr>
            <td>{{ r.user.part }}</td>
            <td>{{ r.user.branch }}</td>
            <td>{{ r.user.name }}</td>
            <td>{{ r.user.id }}</td>
            <td class="money-cell">{{ r.pay_amount_sum|intcomma }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted py-3">데이터 없음</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <hr class="my-4">

    <!-- =========================
      2-2) 수수료 미결
    ========================== -->
    <div class="text-center fw-bold mb-2">수수료 미결현황</div>

    <div class="table-responsive commission-table-scroll">
      <table class="table table-bordered table-sm commission-nowrap-table">
        <thead class="table-light">
          <tr>
            <th>부서</th><th>영업가족</th><th>사원명</th><th>성명</th>
            <th>사번</th><th>상태</th><th>유자격</th><th>실지급</th><th>결재</th>
          </tr>
        </thead>
        <tbody>
          {% for r in pending_rows %}
          <tr>
            <td>{{ r.user.part }}</td>
            <td>{{ r.user.branch }}</td>
            <td>{{ r.emp_name }}</td>
            <td>{{ r.user.name }}</td>
            <td>{{ r.user.id }}</td>
            <td>{{ r.user.status }}</td>
            <td>{{ r.user.regist }}</td>
            <td class="money-cell">{{ r.actual_pay|intcomma }}</td>
            <td>{{ r.approval_flag }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-muted py-3 text-center">데이터 없음</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- =========================
  Excel Upload Modal / Toast
========================== -->
{% include "commission/_approval_upload_modal.html" %}
<script src="{% static 'js/commission/approval_excel_upload.js' %}"></script>
{% endblock %}
