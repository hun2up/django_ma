<!--django_ma/partner/templates/partner/manage_efficiency.html-->
{% extends "base.html" %}
{% load static %}

{% block title %}지점효율{% endblock %}

{% block content %}

{# =========================================================
   ✅ 접근제어 안내 (편제/요율과 동일 톤)
   ========================================================= #}
{% if user.grade != 'superuser' and user.grade != 'main_admin' and user.grade != 'sub_admin' %}
  <div class="alert alert-danger text-center fw-bold">
    접근 권한이 없습니다.
  </div>
{% endif %}

{# 메시지 영역 #}
{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} text-center fw-bold" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<h3 class="text-center fw-bold mb-4" style="color:#003f7d;">지점효율 페이지</h3>

{# =========================================================
   ✅ 루트 컨테이너 (base.css에서 #manage-rate/#manage-structure처럼 확장)
   - 지점효율도 동일 폭을 쓰고 싶으면 base.css에 #manage-efficiency 추가 권장
   ========================================================= #}
<div id="manage-efficiency"
     data-user-grade="{{ user.grade }}"
     data-user-level="{{ user.level|default_if_none:'' }}"
     data-team-a="{{ user.team_a|default_if_none:'' }}"
     data-team-b="{{ user.team_b|default_if_none:'' }}"
     data-team-c="{{ user.team_c|default_if_none:'' }}"
     data-default-branch="{{ user.branch|default_if_none:'' }}"
     data-fetch-url="{% url 'partner:ajax_efficiency_fetch' %}">
     
  {# =========================================================
     ✅ 상단 컨트롤 카드 (기간/부서/지점 + 조회 버튼)
     - superuser만 부서/지점 선택 노출
     ========================================================= #}
  <div class="card shadow p-3 border-0 rounded-4 mb-3">
    <form id="controlsForm" class="row g-2 align-items-end">

      <div class="col-6 col-md-2">
        <label class="form-label mb-1">연도</label>
        <select id="yearSelect" class="form-select form-select-sm"></select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label mb-1">월도</label>
        <select id="monthSelect" class="form-select form-select-sm"></select>
      </div>

      {# ✅ superuser 전용: 부서/지점 선택 #}
      {% if user.grade == 'superuser' %}
      <div class="col-12 col-md-3">
        <label class="form-label mb-1">부서</label>
        <select id="partSelect" class="form-select form-select-sm">
          <option value="">부서 선택</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label mb-1">지점</label>
        <select id="branchSelect" class="form-select form-select-sm" disabled>
          <option value="">지점 선택</option>
        </select>
      </div>
      {% else %}
      {# ✅ main_admin/sub_admin: 지점은 고정(표시용) #}
      <div class="col-12 col-md-6">
        <label class="form-label mb-1">지점</label>
        <input type="text" class="form-control form-control-sm" value="{{ user.branch }}" readonly>
      </div>
      {% endif %}

      <div class="col-12 col-md-2 d-grid">
        <button type="button" id="btnSearchPeriod" class="btn btn-primary btn-sm">
          조회
        </button>
      </div>

    </form>
  </div>

  {# =========================================================
     ✅ 메인시트 카드 (조회 결과)
     ========================================================= #}
  <div id="mainSheet" class="card shadow p-3 border-0 rounded-4" hidden>
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold text-blue">조회 결과</div>
      <div class="text-muted" style="font-size:0.9rem;">
        * 지표/컬럼은 추후 확장 예정
      </div>
    </div>

    <div class="table-responsive">
      <table id="mainTable" class="table table-bordered table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">지점</th>
            <th class="text-center">월도</th>
            <th class="text-center">지표</th>
            <th class="text-center">값</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="text-center text-muted">조회 버튼을 눌러 데이터를 불러오세요.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

{# =========================================================
   ✅ 로딩 오버레이 (base.css 공용)
   ========================================================= #}
<div id="loadingOverlay" class="loading-overlay" hidden>
  <div class="loading-box">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold">처리 중...</div>
  </div>
</div>

{# =========================================================
   ✅ 공용 JS
   - superuser 부서/지점 로딩: part_branch_selector.js
   - 지점효율 전용 JS: manage_efficiency/index.js
   ========================================================= #}
<script src="{% static 'js/common/part_branch_selector.js' %}"></script>

{# DataTables는 “있으면 사용/없으면 fallback” 구조라
   다른 페이지처럼 include 해도 되고, 안 해도 됩니다.
   향후 확정 시 include 여부 선택하세요. #}
{# <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script> #}
{# <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script> #}

<script type="module" src="{% static 'js/partner/manage_efficiency/index.js' %}"></script>

{% endblock %}
