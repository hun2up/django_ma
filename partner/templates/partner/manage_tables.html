<!-- django_ma/partner/templates/partner/manage_tables.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}í…Œì´ë¸” ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container mt-5" id="manage-tables"
     data-fetch-parts-url="{% url 'partner:ajax_fetch_parts' %}"
     data-fetch-branches-url="{% url 'partner:ajax_fetch_branches' %}">

    <!-- âœ… ì ‘ê·¼ ì œí•œ ì•ˆë‚´ -->
    {% if user.grade != 'superuser' and user.grade != 'main_admin' %}
        <div class="alert alert-danger text-center">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endif %}

    <h2 class="fw-bold text-center mb-4" style="color:#003f7d;">í…Œì´ë¸” ê´€ë¦¬ í˜ì´ì§€</h2>

    <!-- âœ… Superuser ì „ìš© -->
    {% if user.grade == 'superuser' %}
        <div class="card shadow p-3 border-0 rounded-4 mb-3">
            <form id="filterForm" class="d-flex flex-wrap align-items-end gap-3">
                <!-- ë¶€ì„œ ì„ íƒ -->
                <div style="flex: 0 0 220px;">
                <label for="partSelect" class="form-label fw-semibold">ë¶€ì„œ</label>
                <select id="partSelect" class="form-select form-select-sm">
                    <option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                </div>

                <!-- ì§€ì  ì„ íƒ -->
                <div style="flex: 0 0 300px;">
                <label for="branchSelect" class="form-label fw-semibold">ì§€ì </label>
                <select id="branchSelect" class="form-select form-select-sm" disabled>
                    <option value="">ë¶€ì„œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                </select>
                </div>

                <!-- ë²„íŠ¼ -->
                <div>
                <button type="button" id="btnSelect" class="btn btn-primary btn-sm px-4" disabled>
                    ì„ íƒ
                </button>
                </div>
            </form>
        </div>
    {% endif %}

    <div class="text-center mt-5">
        <p class="text-muted">ğŸš§ ì œì‘ì¤‘ì…ë‹ˆë‹¤ ğŸš§</p>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const root = document.getElementById("manage-tables");
  if (!root) return;

  const partSelect = document.getElementById("partSelect");
  const branchSelect = document.getElementById("branchSelect");
  const btnSelect = document.getElementById("btnSelect");

  const fetchPartsUrl = root.dataset.fetchPartsUrl;
  const fetchBranchesUrl = root.dataset.fetchBranchesUrl;

  /** -------------------------
   * âœ… ë¶€ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
   * ------------------------- */
  async function loadParts() {
    try {
      const res = await fetch(fetchPartsUrl);
      const data = await res.json();

      partSelect.innerHTML = `<option value="">ì„ íƒ</option>`;
      data.parts.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        partSelect.appendChild(opt);
      });
    } catch (err) {
      console.error("ë¶€ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      partSelect.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>`;
    }
  }

  /** -------------------------
   * âœ… ì„ íƒëœ ë¶€ì„œì˜ ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
   * ------------------------- */
  async function loadBranches(part) {
    try {
      const res = await fetch(`${fetchBranchesUrl}?part=${encodeURIComponent(part)}`);
      const data = await res.json();

      branchSelect.innerHTML = `<option value="">ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”</option>`;
      data.branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        branchSelect.appendChild(opt);
      });

      branchSelect.disabled = false;
      btnSelect.disabled = true;
    } catch (err) {
      console.error("ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      branchSelect.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>`;
      branchSelect.disabled = true;
    }
  }

  /** -------------------------
   * âœ… ì´ë²¤íŠ¸ í•¸ë“¤ë§
   * ------------------------- */
  partSelect.addEventListener("change", () => {
    const selectedPart = partSelect.value;
    branchSelect.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>`;
    branchSelect.disabled = true;
    btnSelect.disabled = true;
    if (selectedPart) loadBranches(selectedPart);
  });

  branchSelect.addEventListener("change", () => {
    btnSelect.disabled = !branchSelect.value;
  });

  btnSelect.addEventListener("click", () => {
    alert(`ì„ íƒëœ ë¶€ì„œ: ${partSelect.value}\nì„ íƒëœ ì§€ì : ${branchSelect.value}`);
  });

  // ì´ˆê¸° ë¡œë“œ ì‹œ ë¶€ì„œ ëª©ë¡ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
  await loadParts();
});
</script>
{% endblock %}
