<!-- django_ma/partner/templates/partner/manage_rate.html -->

{% extends 'base.html' %}
{% load static %}
{% block title %}요율변경 요청{% endblock %}

{% block extra_head %}
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" id="manage-rate"
    data-user-grade="{{ user.grade }}"
    data-current-year="{{ current_year|default:''|default_if_none:'' }}{% if not current_year %}{% now 'Y' %}{% endif %}"
    data-current-month="{{ current_month|default:''|default_if_none:'' }}{% if not current_month %}{% now 'n' %}{% endif %}"
    data-selected-year="{% firstof selected_year current_year %}"
    data-selected-month="{% firstof selected_month current_month %}"
    data-default-branch="{{ user.branch }}"
    data-data-fetch-url="{% url 'partner:ajax_fetch' %}"
    data-data-save-url="{% url 'partner:ajax_save' %}"
    data-data-delete-url="{% url 'partner:ajax_delete' %}">

  <h3 class="fw-bold text-center mb-4" style="color:#003f7d;">요율변경 요청 페이지</h3>

  <!-- ✅ 내용입력 카드 -->
  <div class="card shadow-sm p-3 mb-4">
    <h5 class="fw-bold text-primary mb-3">내용입력</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" id="inputTable">
        <thead class="table-light">
          <tr>
            <th>요청자명</th>
            <th>요청자사번</th>
            <th>요청자지점</th>
            <th>대상자명</th>
            <th>대상자사번</th>
            <th>손보(변경전)</th>
            <th>손보요율(%)</th>
            <th>손보(변경후)</th>
            <th>손보요율(%)</th>
            <th>생보(변경전)</th>
            <th>생보요율(%)</th>
            <th>생보(변경후)</th>
            <th>생보요율(%)</th>
            <th>비고</th>
            <th>삭제</th>
          </tr>
        </thead>
        <tbody>
          <tr class="input-row">
            <td><input type="text" name="rq_name" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="rq_id" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="rq_branch" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="tg_name" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="tg_id" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="before_ftable" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="before_frate" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="after_ftable" class="form-control form-control-sm"></td>
            <td><input type="text" name="after_frate" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="before_ltable" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="before_lrate" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="after_ltable" class="form-control form-control-sm"></td>
            <td><input type="text" name="after_lrate" class="form-control form-control-sm" readonly></td>
            <td><input type="text" name="memo" class="form-control form-control-sm"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger btnRemoveRow">삭제</button></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="mt-3 text-end">
      <button id="btnAddRow" class="btn btn-outline-primary btn-sm me-2">행 추가</button>
      <button id="btnResetRows" class="btn btn-outline-secondary btn-sm me-2">초기화</button>
      <button id="btnSaveRows" class="btn btn-success btn-sm">저장</button>
    </div>
  </div>

  <!-- ✅ 메인시트 (조회 결과) -->
  <div class="card shadow-sm p-3">
    <h5 class="fw-bold text-primary mb-3">요율변경 요청 내역</h5>
    <table class="table table-bordered table-hover text-center" id="mainTable">
      <thead class="table-light">
        <tr>
          <th>요청자</th>
          <th>대상자</th>
          <th>손보(변경전→후)</th>
          <th>생보(변경전→후)</th>
          <th>비고</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ✅ 로딩 오버레이 -->
  <div id="loadingOverlay" hidden
      style="position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(255,255,255,0.7);display:flex;align-items:center;
      justify-content:center;z-index:2000;flex-direction:column;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold">처리 중...</div>
  </div>
</div>

<!-- ✅ 현재 로그인 사용자 정보 전달 -->
<script>
  window.currentUser = {
    id: "{{ user.id }}",
    name: "{{ user.name|escapejs }}",
    branch: "{{ user.branch|escapejs }}",
    part: "{{ user.part|escapejs }}",
    grade: "{{ user.grade|escapejs }}",
  };
</script>

{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'js/partner/manage_rate/index.js' %}"></script>
{% endblock %}
