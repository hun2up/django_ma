<!-- django_ma/partner/templates/partner/manage_grades.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}권한관리{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}

{% if user.grade != 'superuser' and user.grade != 'main_admin' %}
  <div class="alert alert-danger text-center mt-4">접근 권한이 없습니다.</div>
{% endif %}

{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} text-center fw-bold" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<form id="csrfForm">{% csrf_token %}</form>

<div id="manage-grades"
     data-user-grade="{{ user.grade }}"
     data-branch="{{ user.branch }}">

  <h3 class="text-center fw-bold mb-4" style="color:#003f7d;">권한관리 페이지</h3>

  <!-- ✅ superuser: 부서 + 지점 선택 -->
  {% if user.grade == 'superuser' %}
  <div class="card shadow p-3 border-0 rounded-4 mb-3" id="filterCard">
    <form id="filterForm" class="d-flex flex-wrap align-items-end gap-3" method="get">
      <div style="flex:0 0 220px;">
        <label for="partSelect" class="form-label fw-semibold">부서</label>
        <select id="partSelect" name="part" class="form-select form-select-sm">
          <option value="">불러오는 중...</option>
        </select>
      </div>

      <div style="flex:0 0 300px;">
        <label for="branchSelect" class="form-label fw-semibold">지점</label>
        <select id="branchSelect" name="branch" class="form-select form-select-sm" disabled>
          <option value="">부서를 먼저 선택하세요</option>
        </select>
      </div>

      <div style="flex:0 0 120px;">
        <button type="submit" id="btnSearch" class="btn btn-primary btn-sm px-4" disabled>검색</button>
      </div>

      <!-- ✅ 초기값: view에서 내려주는 값(JS가 우선 사용) -->
      <input type="hidden" id="selectedPartInit" value="{{ selected_part|default:'' }}">
      <input type="hidden" id="selectedBranchInit" value="{{ selected_branch|default:'' }}">
    </form>
  </div>
  {% endif %}

  <!-- ✅ 숨겨진 업로드 폼 -->
  <form id="excelUploadForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'partner:upload_grades_excel' %}">
    {% csrf_token %}
    <input type="file" name="excel_file" id="excelFile" accept=".xlsx,.xls" hidden>
  </form>

  <!-- ✅ 상단: 중간관리자 명단 -->
  <div class="card shadow p-3 border-0 rounded-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold mb-0" style="color:#003f7d;">중간관리자 명단</h5>
      <span class="text-muted small" style="white-space: nowrap;">※ 중간관리자 추가/제외는 부서장에게 문의바랍니다.</span>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="subAdminTable">
        <thead class="table-light">
          <tr>
            <th>부서</th><th>지점</th><th>성명</th><th>사번</th><th>직급</th>
            <th>레벨</th><th>팀A</th><th>팀B</th><th>팀C</th>
          </tr>
        </thead>
        <tbody>
          {% if selected_part and selected_branch %}
            {% for u in users_subadmin %}
              <tr data-user-id="{{ u.user.id }}">
                <td>{{ u.part|default:"-" }}</td>
                <td>{{ u.branch|default:"-" }}</td>
                <td>{{ u.name|default:"-" }}</td>
                <td>{{ u.user.id|default:"-" }}</td>
                <td>{{ u.position|default:"-" }}</td>
                <td>
                  <select class="form-select form-select-sm level-select">
                    {% for lv in levels %}
                      <option value="{{ lv }}" {% if u.level == lv %}selected{% endif %}>{{ lv }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>{{ u.team_a|default:"-" }}</td>
                <td>{{ u.team_b|default:"-" }}</td>
                <td>{{ u.team_c|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="9" class="text-center text-muted py-3">해당 부서/지점의 중간관리자가 없습니다.</td></tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="9" class="text-center text-muted py-3">부서와 지점을 선택하세요.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ✅ 하단: 전체 사용자 목록 -->
  <div class="card shadow p-3 border-0 rounded-4">
    <h5 class="fw-bold mb-3" style="color:#003f7d;">전체설계사 명단</h5>
    <div class="table-responsive">
      <table id="allUserTable"
             class="table table-striped align-middle"
             data-ajax-base="{% url 'partner:ajax_users_data' %}">
        <thead class="table-light">
          <tr>
            <th>부서</th><th>지점</th><th>성명</th><th>사번</th><th>직급</th>
            <th>팀A</th><th>팀B</th><th>팀C</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">처리 결과</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- ✅ jQuery (DataTables 필수) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>

<!-- ✅ DataTables core -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<!-- ✅ Buttons -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<!-- (선택) Buttons가 DOM에 버튼 렌더링할 때 종종 필요 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- ✅ 공용: 부서/지점 셀렉터 -->
<script type="module" src="{% static 'js/common/part_branch_selector.js' %}?v=20251229_2"></script>

<!-- ✅ XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* =========================================================
   Manage Grades (Refactor)
   - CSRF robust (hidden input 우선 + cookie fallback)
   - DataTables 재진입/BFCache 안전
   - Level update: 빈 CSRF 헤더 방지 (중요)
========================================================= */

/* -------------------------
   0) tiny utils
------------------------- */
function str(v) { return String(v ?? "").trim(); }
function qs(sel, root) { return (root || document).querySelector(sel); }
function qsa(sel, root) { return Array.from((root || document).querySelectorAll(sel)); }

/* -------------------------
   1) CSRF (robust)
------------------------- */
function getCookie(name) {
  const value = `; ${document.cookie || ""}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return "";
}

function getCSRFToken() {
  const input =
    qs('#csrfForm input[name="csrfmiddlewaretoken"]') ||
    qs('input[name="csrfmiddlewaretoken"]');
  const fromInput = str(input?.value);
  if (fromInput) return fromInput;

  const fromCookie = str(getCookie("csrftoken"));
  return fromCookie;
}

/* -------------------------
   2) Toast
------------------------- */
function showToast(message, isSuccess) {
  const toastElement = document.getElementById('statusToast');
  const toastTitle = document.getElementById('toastTitle');
  const toastBody = document.getElementById('toastBody');

  if (!toastElement || !toastTitle || !toastBody) {
    alert(message);
    return;
  }

  if (isSuccess) {
    toastTitle.textContent = '✅ 저장 성공';
    toastElement.classList.remove('text-bg-danger');
    toastElement.classList.add('text-bg-success');
  } else {
    toastTitle.textContent = '❌ 저장 실패';
    toastElement.classList.remove('text-bg-success');
    toastElement.classList.add('text-bg-danger');
  }

  toastBody.textContent = message;

  // Bootstrap Toast가 없으면 alert fallback
  if (window.bootstrap?.Toast) {
    new bootstrap.Toast(toastElement, { delay: 3000 }).show();
  } else {
    alert(message);
  }
}

/* -------------------------
   3) Helpers
------------------------- */
function buildUrlWithParams(base, params) {
  const url = new URL(base, window.location.origin);
  Object.entries(params || {}).forEach(([k, v]) => {
    url.searchParams.set(k, v ?? "");
  });
  return url.toString();
}

function safeDestroyDataTable($table) {
  if (!$table || !$table.length) return;
  if ($.fn.DataTable && $.fn.DataTable.isDataTable($table)) {
    $table.DataTable().clear().destroy(true);
  }
}

function isAllowedGrade(grade) {
  return grade === "superuser" || grade === "main_admin";
}

async function parseJsonResponse(res) {
  const text = await res.text();
  try {
    return { ok: res.ok, status: res.status, data: JSON.parse(text), text };
  } catch {
    return { ok: false, status: res.status, data: null, text };
  }
}

/* -------------------------
   4) DataTables init
------------------------- */
function initTables() {
  const userGrade = "{{ user.grade }}";
  const selectedPart = "{{ selected_part|default:'' }}";
  const selectedBranch = "{{ selected_branch|default:'' }}";

  if (!isAllowedGrade(userGrade)) return;

  // superuser: 둘 다 있어야
  if (userGrade === "superuser" && (!selectedPart || !selectedBranch)) {
    console.log("superuser: 부서/지점 미선택 — DataTables 초기화 생략");
    return;
  }

  // main_admin: 둘 중 하나라도 없으면 생략
  if (!selectedPart || !selectedBranch) {
    console.log("부서/지점 정보 부족 — DataTables 초기화 생략");
    return;
  }

  const $subTable = $("#subAdminTable");
  const $allTable = $("#allUserTable");

  const ajaxBase = str($allTable.data("ajax-base"));
  if (!ajaxBase) {
    console.warn("ajax-base 누락 — allUserTable 초기화 불가");
    return;
  }

  const ajaxUrl = buildUrlWithParams(ajaxBase, {
    part: selectedPart,
    branch: selectedBranch,
  });

  // BFCache/재진입 대비 destroy
  safeDestroyDataTable($subTable);
  safeDestroyDataTable($allTable);

  /* ✅ 중간관리자 명단 */
  $subTable.DataTable({
    paging: true,
    searching: true,
    info: true,
    pageLength: 10,
    autoWidth: false,
    columnDefs: [
      { width: "8%", targets: 0 },
      { width: "12%", targets: 1 },
      { width: "12%", targets: 2 },
      { width: "8%", targets: 3 },
      { width: "10%", targets: 4 },
      { width: "14%", targets: 5 },
      { width: "12%", targets: 6 },
      { width: "12%", targets: 7 },
      { width: "12%", targets: 8 },
    ],
    lengthMenu: [[10, 25, 50, 100], ["10명", "25명", "50명", "100명"]],
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json",
      lengthMenu: "페이지당 인원 _MENU_",
      search: "검색:",
      zeroRecords: "표시할 데이터가 없습니다.",
      info: "총 _TOTAL_명 중 _START_–_END_ 표시",
      infoEmpty: "데이터 없음",
    },
    dom: `
      <'d-flex justify-content-between align-items-center mb-2'
        <'d-flex align-items-center gap-2'l>
        f
      >rtip
    `,
  });

  /* ✅ 전체 사용자 목록 (Ajax) */
  $allTable.DataTable({
    serverSide: true,
    processing: true,
    ajax: { url: ajaxUrl, type: "GET" },
    columns: [
      { data: "part" },
      { data: "branch" },
      { data: "name" },
      { data: "user_id" },
      { data: "position" },
      { data: "team_a" },
      { data: "team_b" },
      { data: "team_c" },
    ],
    pageLength: 10,
    autoWidth: false,
    columnDefs: [
      { width: "8%", targets: 0 },
      { width: "15%", targets: 1 },
      { width: "12%", targets: 2 },
      { width: "10%", targets: 3 },
      { width: "10%", targets: 4 },
      { width: "15%", targets: 5 },
      { width: "15%", targets: 6 },
      { width: "15%", targets: 7 },
    ],
    lengthMenu: [[10, 25, 50, 100], ["10명", "25명", "50명", "100명"]],
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json",
      lengthMenu: "페이지당 인원 _MENU_",
      search: "검색:",
      processing: "로딩 중...",
      zeroRecords: "표시할 데이터가 없습니다.",
    },
    dom: `
      <'d-flex justify-content-between align-items-center mb-2'
        <'d-flex align-items-center gap-2'lB>
        f
      >rtip
    `,
    buttons: [
      {
        text: "<i class='bi bi-download'></i> 엑셀 다운로드",
        className: "btn btn-success btn-sm",
        action: function () {
          const url = buildUrlWithParams(ajaxUrl, { length: 999999 });

          fetch(url, { credentials: "same-origin" })
            .then((res) => {
              if (!res.ok) throw new Error(`서버 응답 오류 (${res.status})`);
              return res.json();
            })
            .then((data) => {
              if (!data.data || !Array.isArray(data.data)) {
                throw new Error("서버에서 잘못된 형식의 데이터를 반환했습니다.");
              }

              const rows = data.data.map((u) => ({
                성명: u.name || "",
                사번: u.user_id || "",
                직급: u.position || "",
                팀A: u.team_a || "",
                팀B: u.team_b || "",
                팀C: u.team_c || "",
              }));

              if (!rows.length) {
                alert("다운로드할 데이터가 없습니다.");
                return;
              }

              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.json_to_sheet(rows);
              XLSX.utils.book_append_sheet(wb, ws, "전체설계사명단");
              XLSX.writeFile(wb, "전체설계사명단.xlsx");
            })
            .catch((err) => {
              alert("엑셀 생성 중 오류가 발생했습니다.");
              console.error("엑셀 다운로드 오류:", err);
            });
        },
      },
      {
        text: "<i class='bi bi-upload'></i> 엑셀 업로드",
        className: "btn btn-success btn-sm",
        action: function () {
          document.getElementById("excelFile")?.click();
        },
      },
    ],
  });

  /* -------------------------
     5) Excel Upload bind
  ------------------------- */
  const excelFile = document.getElementById("excelFile");
  const excelForm = document.getElementById("excelUploadForm");

  if (excelFile && excelForm && !excelFile.dataset.bound) {
    excelFile.dataset.bound = "1";
    excelFile.addEventListener("change", function () {
      if (!this.files.length) return;
      const fileName = this.files[0].name;

      if (confirm(`"${fileName}" 파일을 업로드하시겠습니까?`)) {
        excelForm.submit();
      } else {
        this.value = "";
      }
    });
  }

  /* -------------------------
     6) Level update bind (핵심: 빈 CSRF 헤더 방지)
  ------------------------- */
  if (!$subTable.data("levelBound")) {
    $subTable.data("levelBound", "1");

    $subTable.on("change", ".level-select", async function () {
      const row = $(this).closest("tr");
      const userId = row.data("user-id");
      const newLevel = $(this).val();

      const csrf = getCSRFToken();
      const headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-Requested-With": "XMLHttpRequest",
      };
      // ✅ 중요: CSRF가 비어있으면 헤더에 넣지 않음
      if (csrf) headers["X-CSRFToken"] = csrf;

      try {
        const res = await fetch("{% url 'partner:ajax_update_level' %}", {
          method: "POST",
          headers,
          credentials: "same-origin",
          body: new URLSearchParams({ user_id: userId, level: newLevel }),
        });

        const parsed = await parseJsonResponse(res);

        if (!parsed.ok || !parsed.data) {
          console.error("서버가 JSON이 아닌 응답을 반환:", { status: parsed.status, text: parsed.text });
          throw new Error(`서버 응답이 JSON이 아닙니다. (${parsed.status})`);
        }

        const data = parsed.data;

        if (!res.ok) {
          console.error("요청 실패(HTTP):", res.status, data);
          throw new Error(data?.error || data?.message || `요청 실패 (${res.status})`);
        }

        if (data.success) {
          showToast(`레벨이 ${newLevel}로 성공적으로 변경되었습니다.`, true);
        } else {
          showToast("저장 실패: " + (data.error || "알 수 없는 오류"), false);
        }
      } catch (err) {
        console.error("요청 실패:", err);
        showToast(err?.message || "서버 요청 중 오류가 발생했습니다.", false);
      }
    });
  }
}

/* =========================================================
   Boot
   - DOMContentLoaded
   - BFCache pageshow persisted 재진입 시 재시도
========================================================= */
document.addEventListener("DOMContentLoaded", initTables);
window.addEventListener("pageshow", (e) => {
  if (e.persisted) initTables();
});
</script>

{% endblock %}
