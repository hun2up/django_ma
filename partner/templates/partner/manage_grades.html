{% extends 'base.html' %}
{% load static %}
{% block title %}ê¶Œí•œê´€ë¦¬{% endblock %}

{% block content %}

{% if user.grade != 'superuser' and user.grade != 'main_admin' %}
  <div class="alert alert-danger">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div>
{% endif %}

{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} text-center fw-bold" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<h3 class="text-center fw-bold mb-4" style="color:#003f7d;">ê¶Œí•œê´€ë¦¬ í˜ì´ì§€</h3>

<!-- âœ… ë¶€ì„œ ì„ íƒ (Superuser ì „ìš©) -->
{% if user.grade == 'superuser' %}
<div class="card shadow p-3 border-0 rounded-4 mb-3">
  <form id="controlsForm" class="d-flex align-items-end justify-content-between flex-wrap gap-2" method="get">
    <div class="d-flex align-items-end gap-2 flex-wrap">
      <div>
        <label class="form-label mb-1">ë¶€ì„œ</label>
        <select id="partSelect" name="part" class="form-select form-select-sm" style="width:140px;">
          <option value="" disabled {% if not selected_part %}selected{% endif %} hidden>ì„ íƒ</option>
          {% for p in parts %}
            <option value="{{ p }}" {% if selected_part == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
        <button type="submit" class="btn btn-outline-primary btn-sm px-3">ì¡°íšŒ</button>
      </div>
    </div>
  </form>
</div>
{% endif %}

<!-- âœ… ìˆ¨ê²¨ì§„ ì—…ë¡œë“œ í¼ -->
<form id="excelUploadForm" method="post" enctype="multipart/form-data" action="{% url 'partner:upload_grades_excel' %}">
  {% csrf_token %}
  <input type="file" name="excel_file" id="excelFile" accept=".xlsx,.xls" hidden>
</form>

<!-- âœ… ìƒë‹¨: ì¤‘ê°„ê´€ë¦¬ì ëª…ë‹¨ -->
<div class="card shadow p-3 border-0 rounded-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0" style="color:#003f7d;">ì¤‘ê°„ê´€ë¦¬ì ëª…ë‹¨</h5>
    <span class="text-muted small" style="white-space: nowrap;">â€» ì¤‘ê°„ê´€ë¦¬ì ì¶”ê°€/ì œì™¸ëŠ” ë¶€ì„œì¥ì—ê²Œ ë¬¸ì˜ë°”ëë‹ˆë‹¤.</span>
  </div>
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="subAdminTable">
      <thead class="table-light">
        <tr>
          <th>ë¶€ì„œ</th><th>ì§€ì </th><th>ì„±ëª…</th><th>ì‚¬ë²ˆ</th><th>ì§ê¸‰</th>
          <th>ë ˆë²¨</th><th>íŒ€A</th><th>íŒ€B</th><th>íŒ€C</th>
        </tr>
      </thead>
      <tbody>
        {% if selected_part %}
          {% for u in users_subadmin %}
          <tr data-user-id="{{ u.user.id }}">
            <td>{{ u.part|default:"-" }}</td>
            <td>{{ u.branch|default:"-" }}</td>
            <td>{{ u.name|default:"-" }}</td>
            <td>{{ u.user.id|default:"-" }}</td>
            <td>{{ u.position|default:"-" }}</td>
            <td>
              <select class="form-select form-select-sm level-select">
                {% for lv in levels %}
                  <option value="{{ lv }}" {% if u.level == lv %}selected{% endif %}>{{ lv }}</option>
                {% endfor %}
              </select>
            </td>
            <td>{{ u.team_a|default:"-" }}</td>
            <td>{{ u.team_b|default:"-" }}</td>
            <td>{{ u.team_c|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-center text-muted py-3">í•´ë‹¹ ë¶€ì„œì˜ ì¤‘ê°„ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8" class="text-center text-muted py-3">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- âœ… í•˜ë‹¨: ì „ì²´ ì‚¬ìš©ì ëª©ë¡ -->
<div class="card shadow p-3 border-0 rounded-4">
  <h5 class="fw-bold mb-3" style="color:#003f7d;">ì „ì²´ì„¤ê³„ì‚¬ ëª…ë‹¨</h5>
  <div class="table-responsive">
    <table id="allUserTable" class="table table-striped align-middle"
      data-ajax-url="{% url 'partner:ajax_users_data' %}?part={{ selected_part|default:'' }}">
      <thead class="table-light">
        <tr>
          <th>ë¶€ì„œ</th><th>ì§€ì </th><th>ì„±ëª…</th><th>ì‚¬ë²ˆ</th><th>ì§ê¸‰</th>
          <th>íŒ€A</th><th>íŒ€B</th><th>íŒ€C</th>
        </tr>
      </thead>
    </table>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">ì²˜ë¦¬ ê²°ê³¼</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastBody">
      </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const selectedPart = "{{ selected_part|default:'' }}";
  const subTable = $("#subAdminTable");
  const allTable = $("#allUserTable");

  // âœ… ë¶€ì„œ ë¯¸ì„ íƒ(superuser ì²« ì ‘ì† ì‹œ) â€” DataTable ë¯¸ì´ˆê¸°í™”
  if (!selectedPart) {
    console.log("ë¶€ì„œ ë¯¸ì„ íƒ ìƒíƒœ â€” DataTables ì´ˆê¸°í™” ìƒëµ");
    return;
  }

  /* âœ… ì¤‘ê°„ê´€ë¦¬ì ëª…ë‹¨ */
  subTable.DataTable({
    paging: true,
    searching: true,
    info: true,
    pageLength: 10,
    autoWidth: false,
    columnDefs: [
      { width: "8%", targets: 0 },  // ë¶€ì„œ
      { width: "12%", targets: 1 }, // ì§€ì 
      { width: "12%", targets: 2 }, // ì„±ëª…
      { width: "8%", targets: 3 }, // ì‚¬ë²ˆ
      { width: "10%", targets: 4 }, // ì§ê¸‰
      { width: "14%", targets: 5 }, // ë ˆë²¨
      { width: "12%", targets: 6 }, // íŒ€A
      { width: "12%", targets: 7 }, // íŒ€B
      { width: "12%", targets: 8 }, // íŒ€C
    ],
    lengthMenu: [[10, 25, 50, 100], ["10ëª…", "25ëª…", "50ëª…", "100ëª…"]],
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json",
      lengthMenu: "í˜ì´ì§€ë‹¹ ì¸ì› _MENU_",
      search: "ê²€ìƒ‰:",
      zeroRecords: "í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
      info: "ì´ _TOTAL_ëª… ì¤‘ _START_â€“_END_ í‘œì‹œ",
      infoEmpty: "ë°ì´í„° ì—†ìŒ",
    },
    dom: `
      <'d-flex justify-content-between align-items-center mb-2'
        <'d-flex align-items-center gap-2'l>
        f
      >rtip
    `,
  });

  /* âœ… ì „ì²´ ì‚¬ìš©ì ëª©ë¡ (Ajax) */
  allTable.DataTable({
    serverSide: true,
    processing: true,
    ajax: { url: allTable.data("ajax-url"), type: "GET" },
    columns: [
      { data: "part" },
      { data: "branch" },
      { data: "name" },
      { data: "user_id" },
      { data: "position" },
      { data: "team_a" },
      { data: "team_b" },
      { data: "team_c" },
    ],
    pageLength: 10,
    autoWidth: false,
    columnDefs: [
      { width: "8%", targets: 0 },  // ë¶€ì„œ
      { width: "15%", targets: 1 }, // ì§€ì 
      { width: "12%", targets: 2 }, // ì„±ëª…
      { width: "10%", targets: 3 }, // ì‚¬ë²ˆ
      { width: "10%", targets: 4 }, // ì§ê¸‰
      { width: "15%", targets: 5 }, // íŒ€A
      { width: "15%", targets: 6 }, // íŒ€B
      { width: "15%", targets: 7 }, // íŒ€C
    ],
    lengthMenu: [[10, 25, 50, 100], ["10ëª…", "25ëª…", "50ëª…", "100ëª…"]],
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json",
      lengthMenu: "í˜ì´ì§€ë‹¹ ì¸ì› _MENU_",
      search: "ê²€ìƒ‰:",
      processing: "ë¡œë”© ì¤‘...",
      zeroRecords: "í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
    },
    dom: `
      <'d-flex justify-content-between align-items-center mb-2'
        <'d-flex align-items-center gap-2'lB>
        f
      >rtip
    `,
    buttons: [
      {
        text: "<i class='bi bi-download'></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
        className: "btn btn-success btn-sm",
        action: function () {
          const baseUrl = allTable.data("ajax-url");
          const connector = baseUrl.includes("?") ? "&" : "?";
          const url = `${baseUrl}${connector}length=999999`;

          fetch(url)
            .then(res => {
              if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
              return res.json();
            })
            .then(data => {
              if (!data.data || !Array.isArray(data.data)) {
                throw new Error("ì„œë²„ì—ì„œ ì˜ëª»ëœ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.");
              }

              const rows = data.data.map(u => ({
                ì„±ëª…: u.name || "",
                ì‚¬ë²ˆ: u.user_id || "",
                ì§ê¸‰: u.position || "",
                íŒ€A: u.team_a || "",
                íŒ€B: u.team_b || "",
                íŒ€C: u.team_c || "",
              }));

              if (rows.length === 0) {
                alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
              }

              // âœ… XLSX ìƒì„±
              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.json_to_sheet(rows);
              XLSX.utils.book_append_sheet(wb, ws, "ì „ì²´ì„¤ê³„ì‚¬ëª…ë‹¨");

              // âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
              XLSX.writeFile(wb, "ì „ì²´ì„¤ê³„ì‚¬ëª…ë‹¨.xlsx");
            })
            .catch(err => {
              alert("ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              console.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", err);
            });
        },
      },
      {
        text: "<i class='bi bi-upload'></i> ì—‘ì…€ ì—…ë¡œë“œ",
        className: "btn btn-success btn-sm",
        action: function () {
          document.getElementById("excelFile").click();
        },
      },
    ],
  });

  /* âœ… ì—‘ì…€ ì—…ë¡œë“œ ìë™ ì œì¶œ + ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ */
  const excelFile = document.getElementById("excelFile");
  const excelForm = document.getElementById("excelUploadForm");

  excelFile.addEventListener("change", function () {
    if (!this.files.length) return;
    const fileName = this.files[0].name;

    if (confirm(`"${fileName}" íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      excelForm.submit();
    } else {
      this.value = "";
    }
  });
});
</script>


<script>
// âœ… í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showToast(message, isSuccess) {
    const toastElement = document.getElementById('statusToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    // ì œëª© ë° ìƒ‰ìƒ ì„¤ì •
    if (isSuccess) {
        toastTitle.textContent = 'âœ… ì €ì¥ ì„±ê³µ';
        toastElement.classList.remove('text-bg-danger');
        toastElement.classList.add('text-bg-success');
    } else {
        toastTitle.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
        toastElement.classList.remove('text-bg-success');
        toastElement.classList.add('text-bg-danger');
    }
    
    toastBody.textContent = message;
    
    // ë¶€íŠ¸ìŠ¤íŠ¸ë© Toast ê°ì²´ ìƒì„± ë° í‘œì‹œ
    const toast = new bootstrap.Toast(toastElement, {
        delay: 3000 // 3ì´ˆ í›„ ìë™ ì‚¬ë¼ì§
    });
    toast.show();
}

document.addEventListener("DOMContentLoaded", () => {
  const subTable = $("#subAdminTable");

  // âœ… ë ˆë²¨ ë³€ê²½ ì´ë²¤íŠ¸
  subTable.on("change", ".level-select", function () {
    const row = $(this).closest("tr");
    const userId = row.data("user-id");
    const newLevel = $(this).val();

    fetch("{% url 'partner:ajax_update_level' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: new URLSearchParams({
        user_id: userId,
        level: newLevel,
      }),
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log(`âœ… user ${userId} â†’ ${newLevel} ì €ì¥ ì„±ê³µ`);
          // ğŸ‘‡ alert ëŒ€ì‹  showToast í˜¸ì¶œ
          showToast(`ë ˆë²¨ì´ ${newLevel}ë¡œ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
        } else {
          // ğŸ‘‡ alert ëŒ€ì‹  showToast í˜¸ì¶œ
          showToast("ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), false);
        }
      })
      .catch(err => {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
        // ğŸ‘‡ alert ëŒ€ì‹  showToast í˜¸ì¶œ
        showToast("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", false);
      });
  });
});
</script>

<!-- âœ… XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

{% endblock %}
