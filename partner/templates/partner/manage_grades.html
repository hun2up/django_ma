{% extends 'base.html' %}
{% load static %}
{% block title %}권한관리{% endblock %}

{% block content %}
{% if user.grade != 'superuser' and user.grade != 'main_admin' %}
  <div class="alert alert-danger">접근 권한이 없습니다.</div>
{% endif %}

<h3 class="text-center fw-bold mb-4" style="color:#003f7d;">권한관리 페이지</h3>

<!-- ✅ 부서 선택 (Superuser 전용) -->
{% if user.grade == 'superuser' %}
<div class="card shadow p-3 border-0 rounded-4 mb-3">
  <form id="controlsForm" class="d-flex align-items-end justify-content-between flex-wrap gap-2" method="get">
    <div class="d-flex align-items-end gap-2 flex-wrap">
      <div>
        <label class="form-label mb-1">부서</label>
        <select id="partSelect" name="part" class="form-select form-select-sm" style="width:140px;">
          <option value="">전체</option>
          {% for p in parts %}
            <option value="{{ p }}" {% if selected_part == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
        <button type="submit" class="btn btn-outline-primary btn-sm px-3">조회</button>
      </div>
    </div>
  </form>
</div>
{% endif %}

<!-- ✅ 엑셀 업로드 -->
<div class="d-flex justify-content-end mb-3 gap-2">
  <form id="excelUploadForm" method="post" enctype="multipart/form-data" action="{% url 'partner:upload_grades_excel' %}">
    {% csrf_token %}
    <input type="file" name="excel_file" id="excelFile" accept=".xlsx,.xls" hidden>
    <button type="button" class="btn btn-success btn-sm" id="uploadBtn">
      <i class="bi bi-file-earmark-excel"></i> 엑셀 업로드
    </button>
  </form>
</div>

<!-- ✅ 상단: 중간관리자 -->
<div class="card shadow p-3 border-0 rounded-4 mb-5">
  <h5 class="fw-bold mb-3" style="color:#003f7d;">중간관리자 명단</h5>
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="subAdminTable">
      <thead class="table-light">
        <tr>
          <th>부서</th><th>지점</th><th>성명</th><th>사번</th><th>직급</th>
          <th>팀A</th><th>팀B</th><th>팀C</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users_subadmin %}
        <tr data-user-id="{{ u.user.id }}">
          <td>{{ u.part|default:"-" }}</td>
          <td>{{ u.branch|default:"-" }}</td>
          <td>{{ u.name|default:"-" }}</td>
          <td>{{ u.user.id|default:"-" }}</td>
          <td>{{ u.position|default:"-" }}</td>
          <td class="editable" data-field="team_a">{{ u.team_a|default:"-" }}</td>
          <td class="editable" data-field="team_b">{{ u.team_b|default:"-" }}</td>
          <td class="editable" data-field="team_c">{{ u.team_c|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-muted py-3" style="white-space: pre-line;">{{ empty_message_subadmin }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ 하단: 전체 사용자 (Ajax 서버사이드) -->
<div class="card shadow p-3 border-0 rounded-4">
  <h5 class="fw-bold mb-3" style="color:#003f7d;">전체 사용자 목록</h5>
  <div class="table-responsive">
    <table id="allUserTable" class="table table-striped align-middle" data-ajax-url="{% url 'partner:ajax_users_data' %}?part={{ selected_part|default:'' }}">
      <thead class="table-light">
        <tr>
          <th>부서</th><th>지점</th><th>성명</th><th>사번</th><th>직급</th>
          <th>팀A</th><th>팀B</th><th>팀C</th>
        </tr>
      </thead>
    </table>
  </div>
</div>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ✅ 부서 선택 시 자동 조회
  document.getElementById('partSelect')?.addEventListener('change', () => {
    document.getElementById('controlsForm').submit();
  });

  // ✅ Ajax DataTable 초기화
  if (!$.fn.DataTable.isDataTable('#allUserTable')) {
    $("#allUserTable").DataTable({
      serverSide: true,
      processing: true,
      ajax: {
        url: "{% url 'partner:ajax_users_data' %}?part={{ selected_part|default:'' }}",
        type: "GET",
      },
      columns: [
        { data: "part" },      // 부서
        { data: "branch" },    // 지점
        { data: "name" },      // 성명
        { data: "user_id" },   // 사번
        { data: "position" },  // 직급
        { data: "team_a" },    // 팀A
        { data: "team_b" },    // 팀B
        { data: "team_c" },    // 팀C
      ],
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100], ["10개", "25개", "50개", "100개"]],
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json",
        lengthMenu: "페이지당 사용자수 _MENU_",
        search: "검색:",
        processing: "로딩 중...",
      },
      dom: `
        <'d-flex justify-content-between align-items-center mb-2'
          <'d-flex align-items-center gap-2'lB>
          f
        >rtip
      `,
      buttons: [
        {
          extend: "excel",
          text: "<i class='bi bi-download'></i> 엑셀 다운로드",
          className: "btn btn-success btn-sm",
          exportOptions: { columns: ':visible' },
        },
      ],
    });
  }
});
</script>

<script src="{% static 'js/partner/manage_grades.js' %}"></script>
{% endblock %}
