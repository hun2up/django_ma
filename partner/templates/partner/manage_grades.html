{% extends 'base.html' %}
{% load static %}
{% block title %}권한관리{% endblock %}

{% block content %}
{% if user.grade not in 'superuser main_admin' %}
  <div class="alert alert-danger">접근 권한이 없습니다.</div>
{% endif %}

<h3 class="text-center fw-bold mb-4" style="color:#003f7d;">권한관리 페이지</h3>

<!-- ✅ 부서 선택 (Superuser 전용) -->
{% if user.grade == 'superuser' %}
<div class="card shadow p-3 border-0 rounded-4 mb-3">
  <form id="controlsForm" class="d-flex align-items-end justify-content-between flex-wrap gap-2" method="get">
    <div class="d-flex align-items-end gap-2 flex-wrap">
      <div>
        <label class="form-label mb-1">부서</label>
        <select id="partSelect" name="part" class="form-select form-select-sm" style="width:140px;">
          <option value="">전체</option>
          {% for p in parts %}
            <option value="{{ p }}" {% if selected_part == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
        <button type="submit" class="btn btn-outline-primary btn-sm px-3">조회</button>
      </div>
    </div>
  </form>
</div>
{% endif %}

<!-- ✅ 엑셀 업로드 -->
<div class="d-flex justify-content-end mb-3 gap-2">
  <form id="excelUploadForm" method="post" enctype="multipart/form-data" action="{% url 'partner:upload_grades_excel' %}">
    {% csrf_token %}
    <input type="file" name="excel_file" id="excelFile" accept=".xlsx,.xls" hidden>
    <button type="button" class="btn btn-success btn-sm" id="uploadBtn">
      <i class="bi bi-file-earmark-excel"></i> 엑셀 업로드
    </button>
  </form>
</div>

<!-- ✅ 상단: 중간관리자(SubAdminTemp) 리스트 -->
<div class="card shadow p-3 border-0 rounded-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="fw-bold mb-0" style="color:#003f7d;">중간관리자 명단</h5>
  </div>

  <div class="table-responsive">
    <table class="table table-striped align-middle datatable" id="subAdminTable">
      <thead class="table-light">
        <tr>
          <th>부서</th>
          <th>지점</th>
          <th>성명</th>
          <th>사번</th>
          <th>직급</th>
          <th>팀A</th>
          <th>팀B</th>
          <th>팀C</th>
          <th style="display:none;">등급</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users_subadmin %}
        <tr data-user-id="{{ u.user.id }}">
          <td>{{ u.part|default:"-" }}</td>
          <td>{{ u.branch|default:"-" }}</td>
          <td>{{ u.name|default:"-" }}</td>
          <td>{{ u.user.id|default:"-" }}</td>
          <td>{{ u.position|default:"-" }}</td>
          <td class="editable" data-field="team_a">{{ u.team_a|default:"-" }}</td>
          <td class="editable" data-field="team_b">{{ u.team_b|default:"-" }}</td>
          <td class="editable" data-field="team_c">{{ u.team_c|default:"-" }}</td>
          <td style="display:none;">{{ u.level|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-3" style="white-space: pre-line;">
            {{ empty_message_subadmin }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ 하단: 전체 사용자 목록 (CustomUser) -->
<div class="card shadow p-3 border-0 rounded-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="fw-bold mb-0" style="color:#003f7d;">전체 사용자 목록</h5>
  </div>

  <div class="table-responsive">
    <table class="table table-striped align-middle datatable" id="allUserTable">
      <thead class="table-light">
        <tr>
          <th>부서</th>
          <th>지점</th>
          <th>성명</th>
          <th>사번</th>
          <th>직급</th>
          <th>팀A</th>
          <th>팀B</th>
          <th>팀C</th>
          <th style="display:none;">등급</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users_all %}
        <tr data-user-id="{{ u.id }}">
          <td>{{ u.part|default:"-" }}</td>
          <td>{{ u.branch|default:"-" }}</td>
          <td>{{ u.name|default:"-" }}</td>
          <td>{{ u.id|default:"-" }}</td>
          <td>{{ u.position|default:"-" }}</td>
          <td class="editable" data-field="team_a">{{ u.team_a|default:"-" }}</td>
          <td class="editable" data-field="team_b">{{ u.team_b|default:"-" }}</td>
          <td class="editable" data-field="team_c">{{ u.team_c|default:"-" }}</td>
          <td style="display:none;">{{ u.level|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-3">등록된 사용자가 없습니다.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ JS 연결 -->
<script src="{% static 'js/partner/manage_grades.js' %}"></script>
{% endblock %}
