<!-- django_ma/manual/templates/manual/manual_list.html -->

{% extends "base.html" %}
{% load static %}
{% block title %}업무매뉴얼{% endblock %}

{% block content %}
<!-- =============================================================================
  Manual List Page (FINAL)
  - superuser: 생성 / 정렬 / 삭제 / 일괄수정
  - 일반 사용자: 목록 클릭 → 상세 페이지 이동
  - 기존 id / class / data-* 유지 (JS 영향 없음)
============================================================================= -->

<div class="container manual-list-container">

  <!-- 1) Page Title -->
  <h3 class="text-center fw-bold mb-4 manual-list-title">업무매뉴얼</h3>

  <!-- 2) Top Controls (superuser only) -->
  <div class="d-flex justify-content-end mb-3 gap-2">
    {% if user.is_authenticated and user.grade == "superuser" %}

      <button type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#createManualModal">
        + 새 매뉴얼
      </button>

      <button type="button"
              class="btn btn-outline-secondary"
              id="btnManualEditMode">
        편집
      </button>

      <button type="button"
              class="btn btn-success d-none"
              id="btnManualSaveOrder">
        저장
      </button>

      <button type="button"
              class="btn btn-light d-none"
              id="btnManualDone">
        완료
      </button>

      <!-- CSRF (JS POST 용도) -->
      <form id="manualEditCsrfForm" class="d-none">
        {% csrf_token %}
      </form>

    {% endif %}
  </div>

  <!-- 3) Boot Data (superuser only) -->
  {% if user.is_authenticated and user.grade == "superuser" %}
    <div id="manualListBoot"
         class="d-none"
         data-reorder-url="{% url 'manual:manual_reorder_ajax' %}"
         data-delete-url="{% url 'manual:manual_delete_ajax' %}"
         data-bulk-update-url="{% url 'manual:manual_bulk_update_ajax' %}">
    </div>
  {% endif %}

  <!-- 4) Manual List -->
  <div class="list-group shadow-sm manual-list-group" id="manualListGroup">
    {% for m in manuals %}
      <a class="list-group-item list-group-item-action py-3 manual-item"
         data-id="{{ m.id }}"
         data-access="{% if m.admin_only %}admin{% elif not m.is_published %}staff{% else %}normal{% endif %}"
         data-href="{% url 'manual:manual_detail' m.pk %}"
         href="{% url 'manual:manual_detail' m.pk %}">

        <div class="d-flex justify-content-between align-items-start gap-2">

          <!-- Left: Title / Badges / Sections -->
          <div class="flex-grow-1 manual-item-left">

            <div class="manual-title-row">

              <!-- (A) Title / Edit UI -->
              <div class="manual-title-col">
                <span class="manual-drag-handle d-none"
                      title="드래그로 순서 변경">☰</span>

                <span class="fw-semibold manual-title-text">
                  {{ m.title }}
                </span>

                <!-- Edit mode input -->
                <input type="text"
                       class="form-control form-control-sm manual-title-input d-none"
                       value="{{ m.title|escape }}"
                       maxlength="80">

                <!-- View mode badges -->
                {% if m.admin_only %}
                  <span class="badge manual-badge-admin">관리자 전용</span>
                {% endif %}
                {% if not m.is_published %}
                  <span class="badge manual-badge-staff">직원 전용</span>
                {% endif %}

                <!-- Edit mode access select -->
                <select class="form-select form-select-sm manual-access-select d-none manual-access-select-w">
                  <option value="normal">일반</option>
                  <option value="admin">관리자 전용</option>
                  <option value="staff">직원 전용</option>
                </select>
              </div>

              <!-- (B) Section chips -->
              <div class="manual-section-chips"
                   aria-label="섹션 소제목 목록">
                {% for sec in m.sections.all %}
                  {% if sec.title %}
                    <span class="manual-section-chip">
                      {{ sec.title }}
                    </span>
                  {% endif %}
                {% endfor %}
              </div>

            </div>
          </div>

          <!-- Right: Actions -->
          <div class="d-flex align-items-center gap-2 manual-item-actions">
            {% if user.is_authenticated and user.grade == "superuser" %}
              <button type="button"
                      class="btn btn-sm btn-outline-danger d-none btn-manual-delete">
                삭제
              </button>
            {% endif %}
          </div>

        </div>
      </a>
    {% empty %}
      <div class="p-3 text-muted">
        등록된 매뉴얼이 없습니다.
      </div>
    {% endfor %}
  </div>

</div>

<!-- 5) Modals & Scripts (superuser only) -->
{% if user.is_authenticated and user.grade == "superuser" %}
  {% include "manual/_partials/create_manual_modal.html" %}
  {% include "manual/_partials/manual_list_scripts.html" %}
{% endif %}
{% endblock %}
