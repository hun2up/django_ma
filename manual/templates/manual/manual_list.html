<!-- django_ma/manual/templates/manual/manual_list.html -->

{% extends "base.html" %}
{% block title %}업무매뉴얼{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px;">
<!-- ✅ 타이틀: 페이지 정중앙 -->
  <h3 class="text-center fw-bold mb-4" style="color:#003f7d;">
    업무매뉴얼
  </h3>

  <!-- 버튼 영역 -->
  <div class="d-flex justify-content-end mb-3 gap-2">
    {% if user.is_authenticated and user.grade == "superuser" %}
      <button type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#createManualModal">
        + 새 매뉴얼
      </button>

      <!-- ✅ superuser 전용 편집 버튼 (새 매뉴얼 우측) -->
      <button type="button" class="btn btn-outline-secondary" id="btnManualEditMode">
        편집
      </button>

      <!-- ✅ 편집모드 저장/완료 버튼(처음엔 숨김) -->
      <button type="button" class="btn btn-success d-none" id="btnManualSaveOrder">
        순서 저장
      </button>
      <button type="button" class="btn btn-light d-none" id="btnManualDone">
        완료
      </button>

      <!-- ✅ CSRF 토큰 확보용(HTTPONLY 대비) -->
      <form id="manualEditCsrfForm" class="d-none">{% csrf_token %}</form>
    {% endif %}
  </div>

  <div class="list-group shadow-sm" id="manualListGroup" style="border-radius:14px; overflow:hidden;">
    {% for m in manuals %}
      <a class="list-group-item list-group-item-action py-3 manual-item" data-id="{{ m.id }}" href="{% url 'manual:manual_detail' m.pk %}">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">

            <!-- ✅ 편집모드에서 보일 드래그 핸들(기본 숨김) -->
            <span class="manual-drag-handle d-none" title="드래그로 순서 변경"
                  style="cursor: grab; user-select:none;">☰</span>
                  
            <div class="fw-semibold">{{ m.title }}</div>

            {% if m.admin_only %}
              <span class="badge manual-badge-admin">관리자 전용</span>
            {% endif %}

            {% if not m.is_published %}
              <span class="badge manual-badge-staff">직원 전용</span>
            {% endif %}
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- ✅ 편집모드 삭제 버튼(기본 숨김) -->
            {% if user.is_authenticated and user.grade == "superuser" %}
              <button type="button"
                      class="btn btn-sm btn-outline-danger d-none btn-manual-delete">
                삭제
              </button>
            {% endif %}
          </div>
        </div>
      </a>
    {% empty %}
      <div class="p-3 text-muted">등록된 매뉴얼이 없습니다.</div>
    {% endfor %}
  </div>
</div>

{% if user.is_authenticated and user.grade == "superuser" %}
<div class="modal fade" id="createManualModal" tabindex="-1" aria-hidden="true"
     data-create-url="{% url 'manual:manual_create_ajax' %}">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content manual-modal">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" style="color:#003f7d;">새 매뉴얼 만들기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>

      <div class="modal-body">
        <form id="createManualForm">
          {% csrf_token %}
          <label class="form-label fw-semibold">매뉴얼 이름</label>
          <input type="text" class="form-control" id="manualTitleInput">

            <div class="mt-3">
              <label class="form-label fw-semibold mb-2">공개 범위</label>

              <div class="d-flex flex-column gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="manualAccess" id="manualAccessNormal" value="normal" checked>
                  <label class="form-check-label fw-semibold" for="manualAccessNormal">일반</label>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="radio" name="manualAccess" id="manualAccessAdmin" value="admin">
                  <label class="form-check-label fw-semibold" for="manualAccessAdmin">관리자 전용</label>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="radio" name="manualAccess" id="manualAccessStaff" value="staff">
                  <label class="form-check-label fw-semibold" for="manualAccessStaff">직원 전용</label>
                </div>
              </div>
            </div>

          <div class="alert alert-danger py-2 mt-3 d-none" id="manualCreateError"></div>

          <div class="d-flex gap-2 justify-content-end mt-3">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
            <button type="submit" class="btn btn-primary" id="btnCreateManualConfirm">
              만들기
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% load static %}

<!-- ✅ SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<!-- ✅ Boot 데이터 -->
<script>
  window.ManualListBoot = {
    reorderUrl: "{% url 'manual:manual_reorder_ajax' %}",
    deleteUrl: "{% url 'manual:manual_delete_ajax' %}",
  };
</script>

<!-- ✅ 편집모드 JS -->
<script src="{% static 'js/manual/manual_list_edit.js' %}"></script>

<!-- 기존: 생성 모달 JS -->
<script src="{% static 'js/manual/create_manual_modal.js' %}"></script>

{% endif %}


{% endblock %}
