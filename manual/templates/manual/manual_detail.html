<!-- django_ma/manual/templates/manual/manual_detail.html -->

{% extends "base.html" %}
{% load static %}
{% block title %}매뉴얼{% endblock %}

{% block content %}
<!------------------------------------------------------------------------
  Manual Detail Page (FINAL - Refactor)
  - 상단 타이틀/배지 + 섹션 목차(sticky subnav)
  - superuser: 섹션/블록 CRUD + Quill editor + 첨부 업로드
  - 기존 id/class/data-* 유지 (JS 의존성 영향 0)
-------------------------------------------------------------------------->

<div class="container-fluid my-5">
  <div id="manual-detail">
    <div id="manualDetailTop">

      <!-----------------------------
        1) Header: Title + badges
      ------------------------------>
      <div class="d-flex justify-content-center align-items-center mb-2 gap-2">
        <h3 class="fw-bold mb-0 text-center manual-detail-title">{{ m.title }}</h3>
        {% if m.admin_only %}<span class="badge manual-badge-admin">관리자 전용</span>{% endif %}
        {% if not m.is_published %}<span class="badge manual-badge-staff">직원 전용</span>{% endif %}
      </div>

      <!-----------------------------
        2) Subnav: Section TOC (sticky)
        - 클릭 시 헤더+subnav 높이 고려 스크롤
        - 스크롤 위치에 따라 active 자동 반영
      ------------------------------>
      <div class="manual-subnav" id="manualSubnav">
        <div class="subnav-inner">
          <div class="subnav-title">{{ m.title }}</div>

          <nav class="subnav-links" aria-label="섹션 목차">
            {% for sec in sections %}
              <a href="#sec-{{ sec.id }}"
                 class="jsSubnavLink"
                 data-target="sec-{{ sec.id }}">
                {% if sec.title %}{{ sec.title }}{% else %}(소제목 없음){% endif %}
              </a>
            {% endfor %}
          </nav>
        </div>
      </div>

      <!-----------------------------
        3) Boot: JS에서 읽을 URL 주입
      ------------------------------>
      {% include "manual/_partials/manual_detail_boot.html" %}

      <!-----------------------------
        4) Sections
      ------------------------------>
      <div id="manualSections" class="mt-3">
        {% for sec in sections %}
          <div class="card p-4 mb-3 manual-section"
               id="sec-{{ sec.id }}"
               data-section-id="{{ sec.id }}">

            {# 카드 삭제 버튼(우상단) - superuser only #}
            {% if user.is_authenticated and user.grade == "superuser" %}
              <div class="sec-card-actions">
                <button type="button" class="btn btn-sm btn-danger btnDeleteSection">카드 삭제</button>
              </div>
            {% endif %}

            {# 소제목 + 소제목 수정 버튼 #}
            <div class="sec-title-row">
              <h5 class="sec-title {% if not sec.title %}empty{% endif %}" data-role="secTitleText">
                {% if sec.title %}{{ sec.title }}{% else %}(소제목 없음){% endif %}
              </h5>

              {% if user.is_authenticated and user.grade == "superuser" %}
                <div class="sec-title-actions">
                  <button type="button" class="btn btn-sm btn-outline-secondary btnEditSectionTitle">
                    소제목 수정
                  </button>
                </div>
              {% endif %}
            </div>

            {# ----- Blocks ----- #}
            <div class="manualBlocks" id="manualBlocks-{{ sec.id }}">
              {% for b in sec.blocks.all %}
                <div class="border rounded-3 p-3 mb-3 manual-block"
                     data-block-id="{{ b.id }}"
                     data-image-url="{% if b.image %}{{ b.image.url }}{% endif %}">

                  <div class="manual-block-grid">

                    <div class="manual-block-media">
                      {% if b.image %}
                        <img src="{{ b.image.url }}"
                             class="manual-block-thumb jsManualImg"
                             alt="manual image">
                      {% else %}
                        <div class="text-muted small py-4">이미지 없음</div>
                      {% endif %}
                    </div>

                    <div class="manual-block-text manual-block-content">
                      {{ b.content|safe }}
                    </div>
                  </div>

                  {# 블록 수정/삭제 - superuser only #}
                  {% if user.is_authenticated and user.grade == "superuser" %}
                    <div class="manual-block-actions">
                      <button type="button"
                              class="btn btn-sm btn-outline-secondary btn-edit-block"
                              data-bs-toggle="modal"
                              data-bs-target="#manualBlockModal">
                        수정
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger btn-delete-block">
                        삭제
                      </button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            {# 블록 추가 버튼 - superuser only #}
            {% if user.is_authenticated and user.grade == "superuser" %}
              <div class="d-flex justify-content-end mt-2">
                <button type="button"
                        class="btn btn-sm btn-primary btn-add-block"
                        data-bs-toggle="modal"
                        data-bs-target="#manualBlockModal"
                        data-section-id="{{ sec.id }}">
                  +내용추가
                </button>
              </div>
            {% endif %}

          </div>
        {% endfor %}
      </div>

      <!-----------------------------
        5) Section Add Button (superuser only)
      ------------------------------>
      {% if user.is_authenticated and user.grade == "superuser" %}
        <div class="d-flex justify-content-end mt-2">
          <button type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="btnAddManualSection"
                  data-section-add-url="{% url 'manual:manual_section_add_ajax' %}"
                  data-manual-id="{{ m.id }}">
            +구역추가
          </button>
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-----------------------------
  6) Floating Actions (FAB)
------------------------------>
<div class="manual-fab">
  <a href="{% url 'manual:manual_list' %}" title="매뉴얼 목록으로">
    <img src="{% static 'images/manual/manual_home.png' %}" alt="HOME">
  </a>
  <button type="button" id="btnManualGoTop" title="맨 위로">
    <img src="{% static 'images/manual/manual_top.png' %}" alt="TOP">
  </button>
</div>

<!-----------------------------
  7) Superuser-only: editor + modals + scripts
------------------------------>
{% if user.is_authenticated and user.grade == "superuser" %}
  {% include "manual/_partials/manual_detail_superuser_assets.html" %}
{% endif %}

<!-----------------------------
  8) Subnav/GoTop (page common)
------------------------------>
<script src="{% static 'js/manual/manual_detail_subnav.js' %}?v=20260113_01"></script>
{% endblock %}
